/* BYD Battery Box Visualization v0.0.3 - bundled single file for HACS */
var P=`/* BYD Battery Box Visualization - Shared Styles */
:host{box-sizing:border-box;font-family:var(--ha-card-header-font-family,Roboto,system-ui,Arial);}
*{box-sizing:border-box}

/* BYD Battery Box Visualization - Shared Styles */
:host{box-sizing:border-box;font-family:var(--ha-card-header-font-family,Roboto,system-ui,Arial);} 
*{box-sizing:border-box}

/* Tower container fills available width */
.battery-tower{display:flex;flex-direction:column;gap:4px;min-width:220px;width:100%;max-width:none;margin:0 auto}
.header{position:relative;display:flex;flex-direction:column;gap:6px;background:linear-gradient(180deg,#585858, #383838);border-radius:10px;padding:8px 12px;color:#fff;box-shadow:inset 0 1px 2px rgba(255,255,255,.08), inset 0 -1px 2px rgba(0,0,0,.45)}
.header .row.top{display:flex;align-items:center;gap:10px}
.header .logo{position:relative;border:2px solid #ff3b3b;color:#ff3b3b;border-radius:999px;font-weight:700;padding:2px 8px;font-size:12px}
.header .soc-row{display:flex}
.header .soc{position:relative;flex:1;height:14px;border-radius:8px;background:rgba(0,0,0,.35);overflow:hidden}
.header .soc .fill{position:absolute;left:0;top:0;bottom:0;background:#2e7d32;min-width:0;border-radius:8px}
.header .soc .label{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);font-weight:700;font-size:12px;text-shadow:0 1px 2px rgba(0,0,0,.6)}
/* 40% smaller chips */
.header .chip{cursor:pointer;background:#2f6df3;color:#fff;border-radius:16px;padding:3px 6px;font-weight:600;user-select:none;font-size:10px}
.header .chip.secondary{background:#4b4b4b}
.header .versions{font-size:8px;line-height:1.2;color:#e0e0e0;cursor:pointer}
.header .power{position:absolute; right: 15px; min-width:100px;text-align:right;display:flex;flex-direction:column;line-height:1.1}
.header .power .p-label{font-weight:600;font-size:11px;opacity:.9}
.header .power .p-value{font-weight:700;font-size:12px}

/* Always single-column modules so each module takes full width */
.modules{display:grid;grid-template-columns:1fr;gap:4px;width:100%}

/* White modules with dark text */
.battery-module{position:relative;background:#fff;border-radius:10px;padding:12px 10px 10px 60px;color:#222;border:1px solid #dcdcdc;box-shadow:inset 0 1px 0 rgba(255,255,255,.6);width:100%;
  aspect-ratio: 5 / 2; /* height = 40% of width */
  max-height:180px;
}
/* No-axis variant: remove left reserve and let chart span full width */
.battery-module.no-axis{padding-left:10px}
.battery-module.no-axis .chart{left:8px}

.module-name{position:absolute;right:8px;bottom:6px;font-size:11px;background:rgba(255,255,255,.65);color:#333;padding:2px 6px;border-radius:6px;z-index:4}
.axis{position:absolute;left:8px;top:8px;bottom:8px;width:48px;z-index:1}
.axis .tick{display:none}
.axis .label{position:absolute;left:0;transform:translateY(-50%);font-size:11px;color:#222}

.chart{position:absolute;left:56px;right:8px;top:8px;bottom:8px;overflow:hidden}
/* horizontal orientation lines spanning full module */
.grid-lines{position:absolute;left:0;right:0;top:0;bottom:0;pointer-events:none;z-index:3}
.grid-lines .line{position:absolute;left:0;right:0;border-top:1px dashed rgba(0,0,0,.2)}

.cells{position:absolute;left:0;right:0;bottom:0;top:0;display:flex;align-items:flex-end;gap:2px;padding:0 6px;z-index:2}
.cell{flex:1;min-width:4px;background:#fff;position:relative;border-radius:2px;overflow:hidden;height:100%}
.bar.cur{position:absolute;left:0;right:0;bottom:0;background:#2e7d32;transition:height .6s ease, bottom .6s ease}
.bar.max{position:absolute;left:0;right:0;bottom:0;background:rgba(0,0,0,.08)}
.bar.darkcap{position:absolute;left:0;right:0;bottom:0;background:rgba(0,0,0,.2)}
/* Light green bottom cap between chart min and cell min */
.bar.greencap{position:absolute;left:0;right:0;bottom:0;background:rgba(46,125,50,.25)}
.bar.bluecap{position:absolute;left:0;right:0;bottom:0;background:rgba(30,136,229,.25)}
.cell.balancing .bar.cur{background:#1e88e5}

/* Up/Down animation hint */
.cell.rise .bar.cur{animation:rise 0.6s ease-out}
.cell.fall .bar.cur{animation:fall 0.6s ease-out}
@keyframes rise{0%{box-shadow:0 0 0 rgba(0,0,0,0),0 0 0 rgba(0,0,0,0);transform:translateY(4%)}100%{box-shadow:0 0 0 rgba(0,0,0,0),0 0 0 rgba(0,0,0,0);transform:translateY(0)}}
@keyframes fall{0%{box-shadow:0 0 0 rgba(0,0,0,0),0 0 0 rgba(0,0,0,0);transform:translateY(-4%)}100%{box-shadow:0 0 0 rgba(0,0,0,0),0 0 0 rgba(0,0,0,0);transform:translateY(0)}}

.tooltip{position:absolute;left:0;top:0;transform:none;background:rgba(0,0,0,.85);color:#fff;font-size:11px;padding:4px 6px;border-radius:4px;white-space:nowrap;pointer-events:none;z-index:5}

/* SOC color thresholds */
.soc-low .soc .fill{background:#d32f2f}
.soc-mid .soc .fill{background:#1976d2}
.soc-high .soc .fill{background:#2e7d32}

/* SOC power animation stripes: right for charging (negative), left for discharging (positive) */
.header.charge .soc .fill{background-image:repeating-linear-gradient(135deg, rgba(255,255,255,.15) 0 10px, transparent 10px 20px);animation:moveRight 2s linear infinite}
.header.discharge .soc .fill{background-image:repeating-linear-gradient(225deg, rgba(255,255,255,.15) 0 10px, transparent 10px 20px);animation:moveLeft 2s linear infinite}
@keyframes moveRight{to{background-position-x:40px}}
@keyframes moveLeft{to{background-position-x:-40px}}

/* Stand resembles BYD base with feet */
.battery-stand{position:relative;height:22px;background:#2b2b2b;border-radius:4px;box-shadow:inset 0 1px 1px rgba(255,255,255,.08);margin-top:2px}
.battery-stand .foot{position:absolute;bottom:-6px;width:22px;height:12px;background:#1e1e1e;border-radius:10px 10px 10px 10px/8px 8px 8px 8px;box-shadow:0 2px 0 rgba(0,0,0,.3)}
.battery-stand .foot.left{left:10%}
.battery-stand .foot.right{right:10%}

/* Narrow modules: responsive thinning before overflow */
@media (max-width: 300px){
  /* Start thinning bars earlier, but keep a small gap */
  .cells{gap:1px;padding:0 4px}
  .cell{min-width:2px}
  .axis .label{font-size:10px}
}

/* Extra-narrow modules: prevent overflow by shrinking min-width and gaps to minimum */
@media (max-width: 256px){
  .cells{gap:0;padding:0 2px}
  .cell{min-width:0}
  .axis .label{font-size:9px}
}`;var F=new URL("../styles/battery.css?v=0.0.3",import.meta.url),R=class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this._soc=0,this._soh=0,this._bmuPower=0,this._bmuVersion="",this._bmsVersion="",this._uiMeta="",this._versionsMode=0,this._onToggle=null,this._view="voltage"}connectedCallback(){this._render(),this._ensureCss(),this._setupResizeObserver()}async _ensureCss(){if(!this._sheet)try{let t=typeof window<"u"&&window.__BYD_CSS_TEXT?window.__BYD_CSS_TEXT:await fetch(F).then(i=>i.text()),e=new CSSStyleSheet;await e.replace(t),this.shadowRoot.adoptedStyleSheets=[e],this._sheet=e}catch{}}setBMUPower(t){this._bmuPower=Number(t)||0,this._render()}setBMUVersion(t){this._bmuVersion=t??"",this._render()}setBMSVersion(t){this._bmsVersion=t??"",this._render()}setUIMeta(t){this._uiMeta=t??"",this._render()}setStateOfCharge(t){this._soc=Number(t)||0,this._render()}setStateOfHealth(t){this._soh=Number(t)||0,this._render()}setView(t){let e=t==="temperature"?"temperature":"voltage";this._view!==e?(this._view=e,this._render()):this._render()}showVoltage(){this.setView("voltage"),this.dispatchEvent(new CustomEvent("toggle-view",{detail:{view:"voltage"}}))}showTemperature(){this.setView("temperature"),this.dispatchEvent(new CustomEvent("toggle-view",{detail:{view:"temperature"}}))}_render(){let t=this.shadowRoot;if(!t)return;let e=this._soc<=20?"soc-low":this._soc<=80?"soc-mid":"soc-high",i=this._bmuPower<0?"charge":this._bmuPower>0?"discharge":"",r=this._view==="voltage"?"chip":"chip secondary",l=this._view==="temperature"?"chip":"chip secondary",m=this._versionsMode===0?`BMU ${this._bmuVersion||""}<br>BMS ${this._bmsVersion||""}`:this._uiMeta||"",s=Number(this._bmuPower)||0,p=s<0?"Charging":s>0?"Discharging":"Idle",f=`${Math.abs(Math.round(s))} W`;t.innerHTML=`
      <div class="battery-tower ${e}">
        <div class="header ${i}">
          <div class="row top">
            <div class="logo">BYD</div>
            <div class="${r}" id="voltage">mV</div>
            <div class="${l}" id="temp">\xB0C</div>
            <div class="versions" id="versions">${m}</div>
            <div class="power"><div class="p-label">${p}</div><div class="p-value">${f}</div></div>
          </div>
          <div class="row soc-row">
            <div class="soc"><div class="fill" style="width:${Math.max(0,Math.min(100,this._soc))}%"></div><div class="label">${Math.round(this._soc)}%</div></div>
          </div>
        </div>
      </div>`;let _=t.getElementById("voltage"),g=t.getElementById("temp"),x=t.getElementById("versions");_?.addEventListener("pointerdown",u=>{u.preventDefault(),u.stopPropagation(),this.showVoltage()}),g?.addEventListener("pointerdown",u=>{u.preventDefault(),u.stopPropagation(),this.showTemperature()}),x?.addEventListener("pointerdown",u=>{u.preventDefault(),u.stopPropagation(),this._versionsMode=this._versionsMode?0:1,this._updateVersionsText()}),this._applyResponsive()}_applyResponsive(){let t=this.shadowRoot;if(!t)return;let e=t.getElementById("versions");if(!e)return;let i=this.getBoundingClientRect().width||0;e.style.display=i<300?"none":""}_setupResizeObserver(){this._ro||(typeof ResizeObserver<"u"?(this._ro=new ResizeObserver(()=>this._applyResponsive()),this._ro.observe(this)):window.addEventListener("resize",()=>this._applyResponsive()))}_updateVersionsText(){let t=this.shadowRoot;if(!t)return;let e=t.getElementById("versions");e&&(e.innerHTML=this._versionsMode===0?`BMU ${this._bmuVersion||""}<br>BMS ${this._bmsVersion||""}`:this._uiMeta||"")}};customElements.get("byd-battery-header")||customElements.define("byd-battery-header",R);var W=new URL("../styles/battery.css?v=0.0.3",import.meta.url),L=class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this._name="BMS",this._view="voltage",this._yAxis=!0,this._voltage=[],this._histMax=[],this._histMin=[],this._temp=[],this._balancing=[],this._chart={vMin:3100,vMax:3700,tMin:0,tMax:60},this._last={voltage:[],temp:[],histMin:[],histMax:[]},this._tip={showUntil:0,x:0,y:0,text:""},this._showGrayCaps=!0}connectedCallback(){this._render(),this._ensureCss()}async _ensureCss(){if(!this._sheet)try{let t=typeof window<"u"&&window.__BYD_CSS_TEXT?window.__BYD_CSS_TEXT:await fetch(W).then(i=>i.text()),e=new CSSStyleSheet;await e.replace(t),this.shadowRoot.adoptedStyleSheets=[e],this._sheet=e}catch{}}setVoltage(t){this._setArray("voltage",t)}setHistoryMaxVoltage(t){this._setArray("histMax",t)}setHistoryMinVoltage(t){this._setArray("histMin",t)}setChartMaxVoltage(t){this._chart.vMax=Number(t)||this._chart.vMax,this._render()}setChartMinVoltage(t){this._chart.vMin=Number(t)||this._chart.vMin,this._render()}setTemperature(t){this._setArray("temp",t)}setChartMaxTemperature(t){this._chart.tMax=Number(t)||this._chart.tMax,this._render()}setChartMinTemperature(t){this._chart.tMin=Number(t)||this._chart.tMin,this._render()}setCellBallancing(t){this._balancing=Array.isArray(t)?t:[],this._render()}setShowGrayCaps(t){this._showGrayCaps=t!==!1,this._render()}setStateOfCharge(){}setStateOfHealth(){}setEfficiency(){}setBMUPower(){}setBMUVersion(){}setBMSVersion(){}showVoltage(){this._view="voltage",this._render()}showTemperature(){this._view="temperature",this._render()}showYAxisValues(){this._yAxis=!0,this._render()}hideYAxisValues(){this._yAxis=!1,this._render()}set name(t){this._name=t,this._render()}get name(){return this._name}_setArray(t,e){let i=t==="voltage"?"voltage":t==="histMax"?"histMax":t==="histMin"?"histMin":t;Array.isArray(e)&&(i==="voltage"&&(this._last.voltage=this._voltage.slice()),i==="temp"&&(this._last.temp=this._temp.slice()),i==="histMin"&&(this._last.histMin=this._histMin.slice()),i==="histMax"&&(this._last.histMax=this._histMax.slice()),this["_"+i]=e.slice(),this._render())}_getAxis(){if(this._view==="temperature")return{min:this._chart.tMin,max:this._chart.tMax,unit:"\xB0C"};let t=this._chart.vMin??Math.min(...this._histMin,...this._voltage),e=this._chart.vMax??Math.max(...this._histMax,...this._voltage);return{min:t,max:e,unit:"mV"}}_render(){let t=this.shadowRoot;if(!t)return;let e=this._getAxis(),i=this._view==="temperature";t.innerHTML=`
      <div class="battery-module ${this._yAxis?"":"no-axis"}">
        <div class="axis" style="display:${this._yAxis?"block":"none"}"></div>
        <div class="chart"></div>
        <div class="module-name">${this._name||""}</div>
      </div>
    `;let r=t.querySelector(".axis");this._yAxis&&this._renderAxis(r,e);let l=t.querySelector(".chart"),m=document.createElement("div");m.className="cells";let s=document.createElement("div");s.className="tooltip",s.style.display="none",l.appendChild(s);let p=()=>{s._sticky||(s.style.display="none")};if(this._yAxis){let h=document.createElement("div");h.className="grid-lines";let y=5;for(let n=0;n<=y;n++){let a=n/y,o=document.createElement("div");o.className="line",o.style.top=`${(1-a)*100}%`,h.appendChild(o)}l.appendChild(h)}let f=i?this._temp:this._voltage,_=f.length,g=e.max,x=e.min,u=h=>h==null||isNaN(h)||g===x?0:(Math.min(g,Math.max(x,Number(h)))-x)/(g-x)*100,V=0;if(!i){let h=[];for(let n=0;n<_;n++){let a=Number(this._voltage[n]),o=Number(this._histMin[n]);Number.isFinite(a)&&Number.isFinite(o)&&h.push(Math.max(0,a-o))}(h.length?h.reduce((n,a)=>n+a,0)/h.length:0)<20&&(V=150)}for(let h=0;h<_;h++){let y=Number(f[h]),n=document.createElement("div");n.className="cell";let a=x,o=g;if(!i){let b=Number(this._histMin[h]),v=Number(this._histMax[h]);if(Number.isFinite(b)&&(a=b),Number.isFinite(v)&&(o=v),this._showGrayCaps&&Number.isFinite(a)&&a>x){let C=this._balancing&&(this._balancing[h]===!0||this._balancing[h]===1),T=document.createElement("div");T.className="bar "+(C?"bluecap":"greencap"),T.style.height=u(a)+"%",n.appendChild(T)}let N=u(y);if(Number.isFinite(o)){let C=u(o),T=Math.max(0,C-N);if(T>0){let E=document.createElement("div");E.className="bar max",E.style.bottom=N+"%",E.style.height=T+"%",n.appendChild(E)}}}let c=document.createElement("div");c.className="bar cur";let w=u(y),d=u(a-V),M=Math.max(0,w-d),S=i?this._last.temp[h]:this._last.voltage[h];if(S!==void 0&&!Number.isNaN(Number(S))){let b=0,v=0;if(i)b=0,v=Math.max(0,u(Number(S)));else{let N=a,C=Number(this._last.histMin[h]);Number.isFinite(C)&&(N=C);let T=u(N-V),E=u(Number(S));b=T,v=Math.max(0,E-T)}c.style.transition="none",c.style.bottom=b+"%",c.style.height=v+"%",requestAnimationFrame(()=>{c.style.transition="height .6s ease, bottom .6s ease",c.style.bottom=d+"%",c.style.height=M+"%"})}else c.style.bottom=d+"%",c.style.height=M+"%";!i&&this._balancing&&(this._balancing[h]===!0||this._balancing[h]===1)&&n.classList.add("balancing"),n.appendChild(c);let $=`${y} ${e.unit}`,k=b=>{let v=l.getBoundingClientRect();s.style.display="block",s.textContent=$;let N=s.offsetWidth||50,C=s.offsetHeight||20,T=b&&typeof b.clientX=="number"&&typeof b.clientY=="number"&&(b.clientX!==0||b.clientY!==0),E,A;if(T)E=b.clientX-v.left+10,A=b.clientY-v.top-10-C;else{let U=n.getBoundingClientRect();E=U.left-v.left+U.width/2+8,A=U.top-v.top-C-8}E=Math.max(6,Math.min(E,v.width-N-6)),A=Math.max(6,Math.min(A,v.height-C-6)),s.style.left=`${E}px`,s.style.top=`${A}px`,this._tip.x=E,this._tip.y=A,this._tip.text=$};n.addEventListener("pointerenter",b=>{k(b)}),n.addEventListener("pointermove",b=>{k(b)}),n.addEventListener("pointerleave",p),n.addEventListener("pointerdown",b=>{k(b),s.style.display="block",s._sticky=!0;let v=Date.now();this._tip.showUntil=v+3e3,clearTimeout(s._t),s._t=setTimeout(()=>{s._sticky=!1,this._tip.showUntil=0,p()},3e3)}),m.appendChild(n)}if(l.appendChild(m),this._tip?.showUntil&&Date.now()<this._tip.showUntil){s.style.display="block",s.textContent=this._tip.text||"";let h=l.getBoundingClientRect(),y=s.offsetWidth||50,n=s.offsetHeight||20,a=this._tip.x,o=this._tip.y;a=Math.max(6,Math.min(a,h.width-y-6)),o=Math.max(6,Math.min(o,h.height-n-6)),s.style.left=`${a}px`,s.style.top=`${o}px`,s._sticky=!0,clearTimeout(s._t);let c=Math.max(0,this._tip.showUntil-Date.now());s._t=setTimeout(()=>{s._sticky=!1,this._tip.showUntil=0,p()},c)}if(_>0){let h=(n,a,o)=>Math.max(a,Math.min(o,n)),y=(n,a)=>{let o=l.getBoundingClientRect(),c=f[a];s.style.display="block",s.textContent=`${c} ${e.unit}`;let w=s.offsetWidth||50,d=s.offsetHeight||20,M=(n?.clientX??o.left+o.width/2)-o.left+10,S=(n?.clientY??o.top+o.height/2)-o.top-10-d;M=h(M,6,o.width-w-6),S=h(S,6,o.height-d-6),s.style.left=`${M}px`,s.style.top=`${S}px`,this._tip.x=M,this._tip.y=S,this._tip.text=`${c} ${e.unit}`};l.addEventListener("pointermove",n=>{let a=l.getBoundingClientRect(),o=a.width-12,c=h((n.clientX-a.left-6)/(o||1),0,1),w=h(Math.floor(c*_),0,_-1);y(n,w)}),l.addEventListener("pointerleave",p)}}_renderAxis(t,e){t.innerHTML="";let i=5;for(let r=0;r<=i;r++){let l=r/i,m=document.createElement("div");m.className="tick",m.style.top=`${(1-l)*100}%`;let s=document.createElement("div");s.className="label";let p=e.min+(e.max-e.min)*l;s.textContent=`${Math.round(p)} ${e.unit}`,s.style.top=`${(1-l)*100}%`,t.appendChild(m),t.appendChild(s)}}};customElements.get("byd-battery-module")||customElements.define("byd-battery-module",L);var G=new URL("../styles/battery.css?v=0.0.3",import.meta.url),H=class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"})}connectedCallback(){this._render(),this._ensureCss()}async _ensureCss(){if(!this._sheet)try{let t=typeof window<"u"&&window.__BYD_CSS_TEXT?window.__BYD_CSS_TEXT:await fetch(G).then(i=>i.text()),e=new CSSStyleSheet;await e.replace(t),this.shadowRoot.adoptedStyleSheets=[e],this._sheet=e}catch{}}_render(){this.shadowRoot.innerHTML='<div class="battery-stand"><div class="foot left"></div><div class="foot right"></div></div>'}};customElements.get("byd-battery-stand")||customElements.define("byd-battery-stand",H);var j=new URL("../styles/battery.css?v=0.0.3",import.meta.url),z=class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this._index=Number(this.getAttribute("index"))||1,this._modules=2,this._header=null,this._moduleEls=[],this._chartV={min:3100,max:3700},this._chartT={min:0,max:60},this._view="voltage"}connectedCallback(){this._render(),this._ensureCss()}async _ensureCss(){if(!this._sheet)try{let t=typeof window<"u"&&window.__BYD_CSS_TEXT?window.__BYD_CSS_TEXT:await fetch(j).then(i=>i.text()),e=new CSSStyleSheet;await e.replace(t),this.shadowRoot.adoptedStyleSheets=[e],this._sheet=e}catch{}}setModules(t){this._modules=Math.max(2,Math.min(10,Number(t)||2)),this._render()}getModulesCount(){return this._modules}setVoltage(t){this._eachModuleData(t,(e,i)=>e.setVoltage(i))}setHistoryMaxVoltage(t){this._eachModuleData(t,(e,i)=>e.setHistoryMaxVoltage(i))}setHistoryMinVoltage(t){this._eachModuleData(t,(e,i)=>e.setHistoryMinVoltage(i))}setChartMaxVoltage(t){this._chartV.max=Number(t)||this._chartV.max,this._moduleEls.forEach(e=>e.setChartMaxVoltage(this._chartV.max))}setChartMinVoltage(t){this._chartV.min=Number(t)||this._chartV.min,this._moduleEls.forEach(e=>e.setChartMinVoltage(this._chartV.min))}setTemperature(t){this._eachModuleData(t,(e,i)=>e.setTemperature(i))}setChartMaxTemperature(t){this._chartT.max=Number(t)||this._chartT.max,this._moduleEls.forEach(e=>e.setChartMaxTemperature(this._chartT.max))}setChartMinTemperature(t){this._chartT.min=Number(t)||this._chartT.min,this._moduleEls.forEach(e=>e.setChartMinTemperature(this._chartT.min))}setCellBallancing(t){this._eachModuleData(t,(e,i)=>e.setCellBallancing(i))}setStateOfCharge(t){this._header?.setStateOfCharge(t)}setStateOfHealth(t){this._header?.setStateOfHealth(t)}setEfficiency(t){}setBMUPower(t){this._header?.setBMUPower(t)}setBMUVersion(t){this._header?.setBMUVersion(t)}setBMSVersion(t){this._header?.setBMSVersion(t)}setUIMeta(t){this._header?.setUIMeta?.(t)}showVoltage(){this._view="voltage",this._header?.setView?.("voltage"),this._moduleEls.forEach(t=>t.showVoltage())}showTemperature(){this._view="temperature",this._header?.setView?.("temperature"),this._moduleEls.forEach(t=>t.showTemperature())}showYAxisValues(){this._moduleEls.forEach(t=>t.showYAxisValues())}hideYAxisValues(){this._moduleEls.forEach(t=>t.hideYAxisValues())}setShowGrayCaps(t){this._moduleEls.forEach(e=>e.setShowGrayCaps?.(t))}_eachModuleData(t,e){if(t&&Array.isArray(t))if(t.length&&typeof t[0]=="object"&&!Array.isArray(t[0]))for(let i of t){let r=(i.m||i.module||1)-1,l=this._moduleEls[r];l&&e(l,i.v||i.t||i.b||[])}else for(let i=0;i<Math.min(this._moduleEls.length,t.length);i++)e(this._moduleEls[i],t[i]||[])}_render(){let t=this.shadowRoot;if(!t)return;t.innerHTML=`
      <div class="battery-tower">
        <byd-battery-header></byd-battery-header>
        <div class="modules"></div>
        <byd-battery-stand></byd-battery-stand>
      </div>
    `,this._header=t.querySelector("byd-battery-header"),this._header.addEventListener("toggle-view",r=>{r.detail.view==="temperature"?this.showTemperature():this.showVoltage()});let e=t.querySelector(".modules");e.innerHTML="",this._moduleEls=[];let i=this._modules;for(let r=0;r<i;r++){let l=document.createElement("byd-battery-module");l.name=`BMS ${this._index}.${r+1}`,l.setChartMinVoltage(this._chartV.min),l.setChartMaxVoltage(this._chartV.max),l.setChartMinTemperature(this._chartT.min),l.setChartMaxTemperature(this._chartT.max),e.appendChild(l),this._moduleEls.push(l)}}};customElements.get("byd-battery-tower")||customElements.define("byd-battery-tower",z);var q=new URL("../styles/battery.css?v=0.0.3",import.meta.url),Y=class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this._towers=1,this._towerEls=[]}connectedCallback(){this._render(),this._ensureCss()}async _ensureCss(){if(!this._sheet)try{let t=typeof window<"u"&&window.__BYD_CSS_TEXT?window.__BYD_CSS_TEXT:await fetch(q).then(i=>i.text()),e=new CSSStyleSheet;await e.replace(t),this.shadowRoot.adoptedStyleSheets=[e],this._sheet=e}catch{}}setTowers(t){this._towers=Math.max(1,Math.min(3,Number(t)||1)),this._render()}getTower(t){return this._towerEls[t-1]}setStateOfCharge(t){this._towerEls.forEach(e=>e?.setStateOfCharge(t))}setStateOfHealth(t){this._towerEls.forEach(e=>e?.setStateOfHealth(t))}setBMUPower(t){this._towerEls.forEach(e=>e?.setBMUPower(t))}setBMUVersion(t){this._towerEls.forEach(e=>e?.setBMUVersion(t))}_render(){let t=this.shadowRoot;if(!t)return;let e=document.createElement("div");e.style.display="grid",e.style.gridTemplateColumns="1fr",e.style.gap="14px",e.style.width="100%",t.innerHTML="",t.appendChild(e),this._towerEls=[];for(let i=0;i<this._towers;i++){let r=document.createElement("byd-battery-tower");r.setAttribute("index",String(i+1)),e.appendChild(r),this._towerEls.push(r)}}};customElements.get("byd-battery-system")||customElements.define("byd-battery-system",Y);var J="0.0.3",O=class extends HTMLElement{static getConfigElement(){return document.createElement("byd-battery-box-visualization-editor")}static getStubConfig(){return{voltage_min:3100,voltage_max:3700,temp_min:10,temp_max:45,show_y_axis:!0,show_gray_caps:!0,unit:"mV"}}setConfig(t){this._config=t||{}}set hass(t){this._hass=t,this._render()}getCardSize(){return 8}_render(){if(!this._hass)return;let t=this._config||{},e=this.shadowRoot||this.attachShadow({mode:"open"});if(!this._el){let n=document.createElement("ha-card"),a=document.createElement("div");a.style.padding="10px";let o=document.createElement("byd-battery-system");a.appendChild(o),n.appendChild(a),e.innerHTML="",e.appendChild(n),this._el={card:n,container:a,system:o},this._lastTowerCount=0,this._lastModules=[]}let i=this._discoverTowers(),r=i.length||1;this._lastTowerCount!==r&&(this._el.system.setTowers(r),this._lastTowerCount=r,this._lastModules=new Array(r).fill(void 0));let l=this._discoverBMU(),m=n=>{let a=Number(n);return Number.isFinite(a)?a:void 0},s=m(t.voltage_min),p=m(t.voltage_max),f=m(t.temp_min),_=m(t.temp_max),g=i.length?Math.min(...i.map(n=>n?.chart?.vMin??99999)):3100,x=i.length?Math.max(...i.map(n=>n?.chart?.vMax??-99999)):3500,u=s!==void 0?s:g,V=p!==void 0?p:x,h=f!==void 0?f:0,y=_!==void 0?_:60;for(let n=0;n<r;n++){let a=i[n],o=this._el.system.getTower(n+1);if(!o||!a)continue;(typeof o.getModulesCount=="function"?Number(o.getModulesCount()):this._lastModules[n]??0)!==a.modules&&(o.setModules(a.modules),this._lastModules[n]=a.modules),o.setChartMinVoltage(u),o.setChartMaxVoltage(V),o.setChartMinTemperature(h),o.setChartMaxTemperature(y),t.show_y_axis===!1?o.hideYAxisValues():o.showYAxisValues(),typeof o.setShowGrayCaps=="function"&&o.setShowGrayCaps(t.show_gray_caps!==!1),o.setBMUPower(l.power??0),o.setBMUVersion(l.version||""),o.setBMSVersion(a.bmsVersion||""),o.setUIMeta?.(`UI ${J}<br>modules:${a.modules}`),o.setStateOfCharge(a.soc??l.soc??0),o.setStateOfHealth(a.soh??0),o.setVoltage(a.voltage),o.setHistoryMaxVoltage(a.histMax),o.setHistoryMinVoltage(a.histMin),o.setCellBallancing(a.balancing),o.setTemperature(a.temps)}}_discoverBMU(){let t=this._hass.states,e=Object.keys(t),i=m=>{let s=e.find(p=>m.test(p));return s?t[s]:void 0},r=Number(i(/^sensor\.bmu_power/)?.state)||0,l=i(/^sensor\.bmu_version$/)?.state||i(/^sensor\.bmu_version_a$/)?.state||"";return{power:r,version:l}}_discoverTowers(){let t=[],e=this._hass.states,i=Object.keys(e),r=[...new Set(i.map(s=>{let p=/^sensor\.bms_(\d+)_cells_average_voltage$/.exec(s);return p?Number(p[1]):null}).filter(Boolean))].sort((s,p)=>s-p).slice(0,3),l=s=>!Array.isArray(s)||s.length===0?0:s.length&&typeof s[0]=="object"&&!Array.isArray(s[0])?s.reduce((p,f)=>{let _=Number(f?.m??f?.module);return Number.isFinite(_)?Math.max(p,_):p},0):s.length,m=(s,p,f)=>{let _=Array.from({length:f},()=>[]);if(!Array.isArray(s))return _;if(s.length&&typeof s[0]=="object"&&!Array.isArray(s[0]))for(let g of s){let x=(Number(g?.m??g?.module)||1)-1;if(x>=0&&x<f){let u=g?.[p];_[x]=Array.isArray(u)?u:[]}}else for(let g=0;g<Math.min(f,s.length);g++)_[g]=Array.isArray(s[g])?s[g]:[];return _};for(let s of r){let p=e[`sensor.bms_${s}_cells_average_voltage`],f=e[`sensor.bms_${s}_max_history_cell_voltage`],_=e[`sensor.bms_${s}_min_history_cell_voltage`],g=e[`sensor.bms_${s}_cells_balancing`],x=e[`sensor.bms_${s}_cells_average_temperature`],u=e[`sensor.bms_${s}_state_of_charge`],V=e[`sensor.bms_${s}_state_of_health`],h=e["sensor.bms_version"],y=p?.attributes?.cell_voltages||[],n=f?.attributes?.cell_voltages||[],a=_?.attributes?.cell_voltages||[],o=g?.attributes?.cell_balancing||[],c=x?.attributes?.cell_temps||[],w=Math.max(l(y),l(n),l(a),l(o),l(c)),d=Math.min(Math.max(w||1,1),10),M=m(y,"v",d),S=m(n,"v",d),D=m(a,"v",d),$=m(o,"b",d),k=m(c,"t",d),b=D.flat().filter(C=>Number.isFinite(C)),v=S.flat().filter(C=>Number.isFinite(C)),N={vMin:b.length?Math.min(...b):3100,vMax:v.length?Math.max(...v):3700};t.push({id:s,modules:d,voltage:M,histMax:S,histMin:D,balancing:$,temps:k,chart:N,soc:Number(u?.state),soh:Number(V?.state),bmsVersion:h?.state||""})}return t.length===0?[this._demoTower(1)]:t}_demoTower(t){let r=Array.from({length:3},()=>Array.from({length:32},()=>3300+Math.round(Math.random()*80))),l=r.map(f=>f.map(_=>_+50)),m=r.map(f=>f.map(_=>_-80)),s=Array.from({length:3},()=>Array.from({length:16},()=>20+Math.round(Math.random()*15))),p=r.map(f=>f.map(()=>Math.random()<.05?1:0));return{id:t,modules:3,voltage:r,histMax:l,histMin:m,balancing:p,temps:s,chart:{vMin:3200,vMax:3500},soc:75,soh:98,bmsVersion:"demo"}}};customElements.get("byd-battery-box-visualization")||customElements.define("byd-battery-box-visualization",O);window.customCards=window.customCards||[];window.customCards.push({type:"byd-battery-box-visualization",name:"BYD Battery Box Visualization",description:"BYD Battery Box visualization with separated components and auto-configuration for byd_battery_box.",preview:!0,preview_image:"/hacsfiles/byd_battery_box_visualization/images/preview.png"});var I=class extends HTMLElement{setConfig(t){if(this._config=t||{},this._form&&customElements.get("ha-form")){let e=this._config||{};this._form.data={unit:e.unit||"mV",voltage_min:e.voltage_min,voltage_max:e.voltage_max,temp_min:e.temp_min,temp_max:e.temp_max,show_y_axis:e.show_y_axis!==!1,show_gray_caps:e.show_gray_caps!==!1};return}this._render()}set hass(t){this._hass=t,this._form&&(this._form.hass=t)}connectedCallback(){this._render()}_render(){this.innerHTML="";let t=this,e=this._config||{};if(customElements.get("ha-form")){let a=document.createElement("ha-form");a.hass=this._hass,a.schema=[{name:"unit",label:"Unit",helper:"Display unit for charts. Default: mV",selector:{select:{options:[{value:"mV",label:"mV"},{value:"\xB0C",label:"\xB0C"}]}}},{name:"voltage_min",label:"Voltage min (mV)",helper:"Minimum of the voltage chart. Default: auto (from history)",selector:{number:{mode:"box",min:0,step:1}}},{name:"voltage_max",label:"Voltage max (mV)",helper:"Maximum of the voltage chart. Default: auto (from history)",selector:{number:{mode:"box",min:0,step:1}}},{name:"temp_min",label:"Temperature min (\xB0C)",helper:"Minimum of the temperature chart. Default: 0",selector:{number:{mode:"box",min:-40,max:120,step:1}}},{name:"temp_max",label:"Temperature max (\xB0C)",helper:"Maximum of the temperature chart. Default: 60",selector:{number:{mode:"box",min:-40,max:120,step:1}}},{name:"show_y_axis",label:"Show Y\u2011axis",helper:"Show axis labels and guide lines. Default: true",selector:{boolean:{}}},{name:"show_gray_caps",label:"Show gray caps (voltage)",helper:"Show dark gray caps beyond per-cell historic min/max. Default: true",selector:{boolean:{}}}],a.data={unit:e.unit||"mV",voltage_min:e.voltage_min,voltage_max:e.voltage_max,temp_min:e.temp_min,temp_max:e.temp_max,show_y_axis:e.show_y_axis!==!1,show_gray_caps:e.show_gray_caps!==!1},a.addEventListener("value-changed",o=>{o.stopPropagation();let c=o.detail?.value||{},w={};Object.keys(c).forEach(d=>{c[d]!==void 0&&(w[d]=c[d])}),clearTimeout(this._debounceT),this._debounceT=setTimeout(()=>{let d=this._config||e||{};this.dispatchEvent(new CustomEvent("config-changed",{detail:{config:{...d,...w}}}))},300)}),this._form=a,t.appendChild(a);return}let i=document.createElement("div");i.style.display="grid",i.style.gridTemplateColumns="1fr 1fr",i.style.gap="8px";let r=(a,o,c)=>{let w=document.createElement("label");w.textContent=a,w.style.fontSize="12px",w.style.opacity="0.85";let d=document.createElement("div");d.textContent=c||"",d.style.fontSize="11px",d.style.opacity="0.7",d.style.marginBottom="2px";let M=document.createElement("div");M.style.display="flex",M.style.flexDirection="column",M.appendChild(w),c&&M.appendChild(d),M.appendChild(o),i.appendChild(M)},l=a=>{let o=document.createElement("input");return o.type="text",o.value=a||"",o},m=a=>{let o=document.createElement("input");return o.type="number",a!==void 0&&(o.value=a),o},s=a=>{let o=document.createElement("input");return o.type="checkbox",o.checked=!!a,o},p=(a,o)=>{let c=document.createElement("select");return o.forEach(w=>{let d=document.createElement("option");d.value=w,d.textContent=w,w===a&&(d.selected=!0),c.appendChild(d)}),c},f=l(e.entity||"");r("Entity (optional)",f,"Usually auto-discovered.");let _=p(e.unit||"mV",["mV","\xB0C"]);r("Unit",_,"Default: mV");let g=m(e.voltage_min);r("Voltage min (mV)",g,"Default: auto (from history)");let x=m(e.voltage_max);r("Voltage max (mV)",x,"Default: auto (from history)");let u=m(e.temp_min);r("Temperature min (\xB0C)",u,"Default: 0");let V=m(e.temp_max);r("Temperature max (\xB0C)",V,"Default: 60");let h=s(e.show_y_axis!==!1);r("Show Y\u2011axis",h,"Default: true");let y=s(e.show_gray_caps!==!1);r("Show gray caps (voltage)",y,"Default: true");let n=()=>{let a={entity:f.value,unit:_.value,voltage_min:g.value===""?void 0:Number(g.value),voltage_max:x.value===""?void 0:Number(x.value),temp_min:u.value===""?void 0:Number(u.value),temp_max:V.value===""?void 0:Number(V.value),show_y_axis:h.checked,show_gray_caps:y.checked};this.dispatchEvent(new CustomEvent("config-changed",{detail:{config:{...e,...a}}}))};i.addEventListener("change",n),t.appendChild(i)}};customElements.get("byd-battery-box-visualization-editor")||customElements.define("byd-battery-box-visualization-editor",I);typeof window<"u"&&(window.__BYD_CSS_TEXT=P);
