/* BYD Battery Box Visualization v0.0.6 - bundled single file for HACS */
try{(globalThis||window).__BYD_CSS_TEXT=":host{box-sizing:border-box;font-family:var(--ha-card-header-font-family,Roboto,system-ui,Arial);display:block}*{box-sizing:border-box}.battery-tower{display:flex;flex-direction:column;gap:4px;min-width:220px;width:100%;max-width:none;margin:0 auto}.header{position:relative;display:flex;flex-direction:column;gap:6px;background:linear-gradient(180deg,#585858, #383838);border-radius:10px;padding:8px 12px;color:#fff;box-shadow:inset 0 1px 2px rgba(255,255,255,.08), inset 0 -1px 2px rgba(0,0,0,.45)}.header .row.top{display:flex;align-items:center;gap:10px}.header .logo{position:relative;border:2px solid #ff3b3b;color:#ff3b3b;border-radius:999px;font-weight:700;padding:2px 8px;font-size:12px;width:90px}.header .logo.nobrandInformation{width:auto}.header .logo .brandname{color:#ff3b3b;float:left;margin-right:4px}.header .capacity{font-size:8px;line-height:1.2;color:#e0e0e0;margin-left:auto}.header .productname{font-size:8px;font-weight:bold;line-height:1.2;color:#e0e0e0;margin-left:auto}.header .soc-row{display:flex}.header .soc{position:relative;flex:1;height:14px;border-radius:8px;background:rgba(0,0,0,.35);overflow:hidden}.header .soc .fill{position:absolute;left:0;top:0;bottom:0;background:#2e7d32;min-width:0;border-radius:8px}.header .soc .label{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);font-weight:700;font-size:12px;text-shadow:0 1px 2px rgba(0,0,0,.6)}.header .chip{cursor:pointer;background:#2f6df3;color:#fff;border-radius:16px;padding:3px 6px;font-weight:600;user-select:none;font-size:10px}.header .chip.secondary{background:#4b4b4b}.header .versions{font-size:8px;line-height:1.2;color:#e0e0e0;cursor:pointer}.header .power{position:absolute;right:15px;min-width:100px;text-align:right;display:flex;flex-direction:column;line-height:1.1}.header .power .p-label{font-weight:600;font-size:11px;opacity:.9}.header .power .p-value{font-weight:700;font-size:12px}.header .power .p-eta{font-weight:600;font-size:10px;opacity:.85}.modules{display:grid;grid-template-columns:1fr;gap:4px;width:100%}.battery-module{position:relative;background:#fff;border-radius:10px;padding:12px 10px 10px 60px;color:#222;border:1px solid #dcdcdc;box-shadow:inset 0 1px 0 rgba(255,255,255,.6);width:100%;aspect-ratio:5 / 2;max-height:180px}.battery-module.minimal{aspect-ratio:5/1;max-height:90px;padding-left:10px}.battery-module .mini{position:absolute;left:10px;right:8px;top:8px;bottom:8px;display:flex;flex-direction:column;gap:6px}.battery-module .mini-row{display:flex;align-items:center;gap:8px}.battery-module .mini-label{width:80px;font-size:10px;opacity:.8}.battery-module .mini-stat{font-size:11px;font-weight:700}.battery-module .hbar{flex:1;position:relative;height:10px;border-radius:6px;background:#fff;border:1px solid #e0e0e0;overflow:hidden}.battery-module.minimal .hbar{height:20px}.battery-module .hseg{position:absolute;top:0;bottom:0}.battery-module .hseg.cur{background:linear-gradient(to left, #000000 0%,#2e7d32 1px,#2e7d32 30%,#3b9440 70%,rgba(46,125,50,.25) 100%)}.battery-module .hseg.cur.bal{background:linear-gradient(to left, #000000 0%,#1e88e5 1px,#1e88e5 30%,#3396e8 70%,rgba(30,136,229,.25) 100%)}.battery-module .hseg.max{background:rgba(0,0,0,.08)}.battery-module .hseg.greencap{background:rgba(46,125,50,.25)}.battery-module .hseg.bluecap{background:rgba(30,136,229,.25)}.battery-module .hnum{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);font-size:10px;font-weight:700;color:#111;text-shadow:0 1px 1px rgba(255,255,255,.7)}.battery-module.minimal .hnum{color:#fff;text-shadow:0 1px 1px rgba(0,0,0,.6)}.battery-module.nodata{height:56px;max-height:none;aspect-ratio:auto;padding:8px 10px}.battery-module.no-axis{padding-left:10px}.battery-module.no-axis .chart{left:8px}.module-name{position:absolute;right:8px;bottom:6px;font-size:11px;background:rgba(255,255,255,.65);color:#333;padding:2px 6px;border-radius:6px;z-index:4}.axis{position:absolute;left:8px;top:8px;bottom:8px;width:48px;z-index:1}.axis .tick{display:none}.axis .label{position:absolute;left:0;transform:translateY(-50%);font-size:11px;color:#222}.chart{position:absolute;left:56px;right:8px;top:8px;bottom:8px;overflow:hidden}.grid-lines{position:absolute;left:0;right:0;top:0;bottom:0;pointer-events:none;z-index:3}.grid-lines .line{position:absolute;left:0;right:0;border-top:1px dashed rgba(0,0,0,.2)}.cells{position:absolute;left:0;right:0;bottom:0;top:0;display:flex;align-items:flex-end;gap:2px;padding:0 6px;z-index:2}.cell{flex:1;min-width:4px;background:#fff;position:relative;border-radius:2px;overflow:hidden;height:100%}.bar.cur{position:absolute;left:0;right:0;bottom:0;background:linear-gradient(to bottom, #000000 0%,#2e7d32 2%,#2e7d32 30%,#3b9440 70%,rgba(46,125,50,.25) 100%);transition:height .6s ease, bottom .6s ease}.bar.max{position:absolute;left:0;right:0;bottom:0;background:rgba(0,0,0,.08)}.bar.darkcap{position:absolute;left:0;right:0;bottom:0;background:rgba(0,0,0,.2)}.bar.greencap{position:absolute;left:0;right:0;bottom:0;background:rgba(46,125,50,.25)}.bar.bluecap{position:absolute;left:0;right:0;bottom:0;background:rgba(30,136,229,.25)}.cell.balancing .bar.cur{background:linear-gradient(to bottom, #000000 0%,#1e88e5 2%,#1e88e5 30%,#3396e8 70%,rgba(30,136,229,.25) 100%)}.cell.rise .bar.cur{animation:rise 0.6s ease-out}.cell.fall .bar.cur{animation:fall 0.6s ease-out}@keyframes rise{0%{box-shadow:0 0 0 rgba(0,0,0,0),0 0 0 rgba(0,0,0,0);transform:translateY(4%)}100%{box-shadow:0 0 0 rgba(0,0,0,0),0 0 0 rgba(0,0,0,0);transform:translateY(0)}}@keyframes fall{0%{box-shadow:0 0 0 rgba(0,0,0,0),0 0 0 rgba(0,0,0,0);transform:translateY(-4%)}100%{box-shadow:0 0 0 rgba(0,0,0,0),0 0 0 rgba(0,0,0,0);transform:translateY(0)}}.tooltip{position:absolute;left:0;top:0;transform:none;background:rgba(0,0,0,.85);color:#fff;font-size:11px;padding:4px 6px;border-radius:4px;white-space:nowrap;pointer-events:none;z-index:5}.soc-low .soc .fill{background:#d32f2f}.soc-mid .soc .fill{background:#1976d2}.soc-high .soc .fill{background:#2e7d32}.header.charge .soc .fill{background-size:30px 220px;background-image:repeating-linear-gradient(135deg, rgba(255,255,255,.15) 0 10px, transparent 10px 20px);animation:moveRight 8s linear infinite}.header.discharge .soc .fill{background-size:30px 220px;background-image:repeating-linear-gradient(225deg, rgba(255,255,255,.15) 0 10px, transparent 10px 20px);animation:moveLeft 8s linear infinite}@keyframes moveRight{from{background-position:0 0}to{background-position-x:200px}}@keyframes moveLeft{from{background-position:0 0}to{background-position-x:-200px}}.battery-stand{position:relative;height:22px;background:#2b2b2b;border-radius:4px;box-shadow:inset 0 1px 1px rgba(255,255,255,.08);margin-top:2px}.battery-stand .foot{position:absolute;bottom:-6px;width:22px;height:12px;background:#1e1e1e;border-radius:10px 10px 10px 10px/8px 8px 8px 8px;box-shadow:0 2px 0 rgba(0,0,0,.3)}.battery-stand .foot.left{left:10%}.battery-stand .foot.right{right:10%}@media (max-width:300px){.cells{gap:1px;padding:0 4px}.cell{min-width:2px}.axis .label{font-size:10px}}@media (max-width:256px){.cells{gap:0;padding:0 2px}.cell{min-width:0}.axis .label{font-size:9px}}";}catch(_){}

var z=`/* BYD Battery Box Visualization - Shared Styles */
:host{box-sizing:border-box;font-family:var(--ha-card-header-font-family,Roboto,system-ui,Arial);display:block;}
*{box-sizing:border-box}

/* Tower container fills available width */
.battery-tower{display:flex;flex-direction:column;gap:4px;min-width:220px;width:100%;max-width:none;margin:0 auto}
.header{position:relative;display:flex;flex-direction:column;gap:6px;background:linear-gradient(180deg,#585858, #383838);border-radius:10px;padding:8px 12px;color:#fff;box-shadow:inset 0 1px 2px rgba(255,255,255,.08), inset 0 -1px 2px rgba(0,0,0,.45)}
.header .row.top{display:flex;align-items:center;gap:10px}
.header .logo{position:relative;border:2px solid #ff3b3b;color:#ff3b3b;border-radius:999px;font-weight:700;padding:2px 8px;font-size:12px; width: 90px}
.header .logo.nobrandInformation {width:auto;}
.header .logo .brandname{color:#ff3b3b;float:left;margin-right:4px}
.header .capacity{font-size:8px;line-height:1.2;color:#e0e0e0;margin-left:auto}
.header .productname {font-size:8px;font-weight:bold;line-height:1.2;color:#e0e0e0;margin-left:auto}
.header .soc-row{display:flex}
.header .soc{position:relative;flex:1;height:14px;border-radius:8px;background:rgba(0,0,0,.35);overflow:hidden}
.header .soc .fill{position:absolute;left:0;top:0;bottom:0;background:#2e7d32;min-width:0;border-radius:8px}
.header .soc .label{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);font-weight:700;font-size:12px;text-shadow:0 1px 2px rgba(0,0,0,.6)}
/* 40% smaller chips */
.header .chip{cursor:pointer;background:#2f6df3;color:#fff;border-radius:16px;padding:3px 6px;font-weight:600;user-select:none;font-size:10px}
.header .chip.secondary{background:#4b4b4b}
.header .versions{font-size:8px;line-height:1.2;color:#e0e0e0;cursor:pointer}
.header .power{position:absolute; right: 15px; min-width:100px;text-align:right;display:flex;flex-direction:column;line-height:1.1}
.header .power .p-label{font-weight:600;font-size:11px;opacity:.9}
.header .power .p-value{font-weight:700;font-size:12px}
.header .power .p-eta{font-weight:600;font-size:10px;opacity:.85}

/* Always single-column modules so each module takes full width */
.modules{display:grid;grid-template-columns:1fr;gap:4px;width:100%}

/* White modules with dark text */
.battery-module{position:relative;background:#fff;border-radius:10px;padding:12px 10px 10px 60px;color:#222;border:1px solid #dcdcdc;box-shadow:inset 0 1px 0 rgba(255,255,255,.6);width:100%;
  aspect-ratio: 5 / 2; /* height = 40% of width */
  max-height:180px;
}
/* Minimalistic variant: 50% height */
.battery-module.minimal{aspect-ratio:5/1; max-height:90px; padding-left:10px}
/* keep module-name bottom-right same as detailed */
.battery-module .mini{position:absolute; left:10px; right:8px; top:8px; bottom:8px; display:flex; flex-direction:column; gap:6px}
.battery-module .mini-row{display:flex; align-items:center; gap:8px}
.battery-module .mini-label{width:80px; font-size:10px; opacity:.8}
.battery-module .mini-stat{font-size:11px; font-weight:700}
.battery-module .hbar{flex:1; position:relative; height:10px; border-radius:6px; background:#fff; border:1px solid #e0e0e0; overflow:hidden}
.battery-module.minimal .hbar{height:20px}
.battery-module .hseg{position:absolute; top:0; bottom:0}
.battery-module .hseg.cur{background: linear-gradient(to left, #000000 0%,#2e7d32 1px,#2e7d32 30%,#3b9440 70%,rgba(46,125,50,.25) 100%)}
/* Balancing variant for minimal horizontal bar */
.battery-module .hseg.cur.bal{background: linear-gradient(to left, #000000 0%,#1e88e5 1px,#1e88e5 30%,#3396e8 70%,rgba(30,136,229,.25) 100%)}
.battery-module .hseg.max{background: rgba(0,0,0,.08)}
.battery-module .hseg.greencap{background: rgba(46,125,50,.25)}
.battery-module .hseg.bluecap{background: rgba(30,136,229,.25)}
.battery-module .hnum{position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); font-size:10px; font-weight:700; color:#111; text-shadow:0 1px 1px rgba(255,255,255,.7)}
.battery-module.minimal .hnum{color:#fff; text-shadow:0 1px 1px rgba(0,0,0,.6)}

/* No Data view: same visual height as header (approx.) */
.battery-module.nodata{height:56px; max-height:none; aspect-ratio:auto; padding:8px 10px}

/* No-axis variant: remove left reserve and let chart span full width */
.battery-module.no-axis{padding-left:10px}
.battery-module.no-axis .chart{left:8px}

.module-name{position:absolute;right:8px;bottom:6px;font-size:11px;background:rgba(255,255,255,.65);color:#333;padding:2px 6px;border-radius:6px;z-index:4}
.axis{position:absolute;left:8px;top:8px;bottom:8px;width:48px;z-index:1}
.axis .tick{display:none}
.axis .label{position:absolute;left:0;transform:translateY(-50%);font-size:11px;color:#222}

.chart{position:absolute;left:56px;right:8px;top:8px;bottom:8px;overflow:hidden}
/* horizontal orientation lines spanning full module */
.grid-lines{position:absolute;left:0;right:0;top:0;bottom:0;pointer-events:none;z-index:3}
.grid-lines .line{position:absolute;left:0;right:0;border-top:1px dashed rgba(0,0,0,.2)}

.cells{position:absolute;left:0;right:0;bottom:0;top:0;display:flex;align-items:flex-end;gap:2px;padding:0 6px;z-index:2}
.cell{flex:1;min-width:4px;background:#fff;position:relative;border-radius:2px;overflow:hidden;height:100%}
.bar.cur{position:absolute;left:0;right:0;bottom:0;background: linear-gradient(to bottom, #000000 0%,#2e7d32 2%,#2e7d32 30%,#3b9440 70%,rgba(46,125,50,.25) 100%);transition:height .6s ease, bottom .6s ease}
.bar.max{position:absolute;left:0;right:0;bottom:0;background:rgba(0,0,0,.08)}
.bar.darkcap{position:absolute;left:0;right:0;bottom:0;background:rgba(0,0,0,.2)}
/* Light green bottom cap between chart min and cell min */
.bar.greencap{position:absolute;left:0;right:0;bottom:0;background:rgba(46,125,50,.25)}
.bar.bluecap{position:absolute;left:0;right:0;bottom:0;background:rgba(30,136,229,.25)}
.cell.balancing .bar.cur{background: linear-gradient(to bottom, #000000 0%,#1e88e5 2%,#1e88e5 30%,#3396e8 70%,rgba(30,136,229,.25) 100%);}

/* Up/Down animation hint */
.cell.rise .bar.cur{animation:rise 0.6s ease-out}
.cell.fall .bar.cur{animation:fall 0.6s ease-out}
@keyframes rise{0%{box-shadow:0 0 0 rgba(0,0,0,0),0 0 0 rgba(0,0,0,0);transform:translateY(4%)}100%{box-shadow:0 0 0 rgba(0,0,0,0),0 0 0 rgba(0,0,0,0);transform:translateY(0)}}
@keyframes fall{0%{box-shadow:0 0 0 rgba(0,0,0,0),0 0 0 rgba(0,0,0,0);transform:translateY(-4%)}100%{box-shadow:0 0 0 rgba(0,0,0,0),0 0 0 rgba(0,0,0,0);transform:translateY(0)}}

.tooltip{position:absolute;left:0;top:0;transform:none;background:rgba(0,0,0,.85);color:#fff;font-size:11px;padding:4px 6px;border-radius:4px;white-space:nowrap;pointer-events:none;z-index:5}

/* SOC color thresholds */
.soc-low .soc .fill{background:#d32f2f}
.soc-mid .soc .fill{background:#1976d2}
.soc-high .soc .fill{background:#2e7d32}

/* SOC power animation stripes: right for charging (negative), left for discharging (positive) */
.header.charge .soc .fill{background-size: 30px 220px;background-image:repeating-linear-gradient(135deg, rgba(255,255,255,.15) 0 10px, transparent 10px 20px);animation:moveRight 8s linear infinite}
.header.discharge .soc .fill{background-size: 30px 220px;background-image:repeating-linear-gradient(225deg, rgba(255,255,255,.15) 0 10px, transparent 10px 20px);animation:moveLeft 8s linear infinite}
@keyframes moveRight{from{background-position: 0 0;} to{background-position-x:200px}}
@keyframes moveLeft{from{background-position: 0 0;} to{background-position-x:-200px}}

/* Stand resembles BYD base with feet */
.battery-stand{position:relative;height:22px;background:#2b2b2b;border-radius:4px;box-shadow:inset 0 1px 1px rgba(255,255,255,.08);margin-top:2px}
.battery-stand .foot{position:absolute;bottom:-6px;width:22px;height:12px;background:#1e1e1e;border-radius:10px 10px 10px 10px/8px 8px 8px 8px;box-shadow:0 2px 0 rgba(0,0,0,.3)}
.battery-stand .foot.left{left:10%}
.battery-stand .foot.right{right:10%}

/* Narrow modules: responsive thinning before overflow */
@media (max-width: 300px){
  /* Start thinning bars earlier, but keep a small gap */
  .cells{gap:1px;padding:0 4px}
  .cell{min-width:2px}
  .axis .label{font-size:10px}
}

/* Extra-narrow modules: prevent overflow by shrinking min-width and gaps to minimum */
@media (max-width: 256px){
  .cells{gap:0;padding:0 2px}
  .cell{min-width:0}
  .axis .label{font-size:9px}
}`;var O=class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this._soc=0,this._soh=0,this._bmuPower=0,this._bmuVersion="",this._bmsVersion="",this._uiMeta="",this._onToggle=null,this._view="voltage",this._displayUnit="mV",this._towerCapacityWh=0,this._etaText="",this._productName="",this._showVTToggle=!0,this._showViewToggle=!1,this._moduleView="detailed",this._showPower=!0,this._showETA=!0,this._showProductCapacity=!0,this._headerInfo={default:"versions",show:{versions:!0,ui:!0,energy:!0,efficiency:!0},payload:{versionsText:"",uiText:"",energyText:"",effText:""}},this._headerInfoIndex=0,this._renderScheduled=!1,this._renderFrame=null,this._renderTimeout=null,this._lastRenderTime=0,this._cssReadyHandler=null,this._dirty=!0}connectedCallback(){this._scheduleRender(),this._adoptCss(),this._setupResizeObserver(),this._visibilityHandler&&document.removeEventListener("visibilitychange",this._visibilityHandler),this._visibilityHandler=()=>{document.visibilityState==="visible"&&this._dirty&&(this._renderScheduled=!1,this._scheduleRender())},document.addEventListener("visibilitychange",this._visibilityHandler)}disconnectedCallback(){this._renderTimeout&&(clearTimeout(this._renderTimeout),this._renderTimeout=null),this._renderFrame&&(cancelAnimationFrame(this._renderFrame),this._renderFrame=null),this._ro&&(this._ro.disconnect(),this._ro=null),this._resizeHandler&&(window.removeEventListener("resize",this._resizeHandler),this._resizeHandler=null),this._cssReadyHandler&&(window.removeEventListener("byd-css-ready",this._cssReadyHandler),this._cssReadyHandler=null),this._visibilityHandler&&(document.removeEventListener("visibilitychange",this._visibilityHandler),this._visibilityHandler=null),this._renderScheduled=!1}_markDirty(){this._dirty=!0,document.visibilityState==="visible"&&this._scheduleRender()}_scheduleRender(){if(this._renderScheduled)return;this._renderScheduled=!0;let t=performance.now()-this._lastRenderTime;t>=500?this._renderFrame=requestAnimationFrame(()=>this._doRender()):this._renderTimeout=setTimeout(()=>{this._renderTimeout=null,this._renderFrame=requestAnimationFrame(()=>this._doRender())},500-t)}_doRender(){this._renderScheduled=!1,this._lastRenderTime=performance.now(),this._dirty&&(this._dirty=!1,this._render())}_adoptCss(){try{let e=typeof globalThis<"u"?globalThis:typeof window<"u"?window:void 0;if(this._sheet||!this.shadowRoot)return;let t=()=>{let i=e&&e.__BYD_CSS_SHEET;i&&this.shadowRoot&&(this.shadowRoot.adoptedStyleSheets=[i],this._sheet=i)};if(e&&e.__BYD_CSS_SHEET){t();return}this._cssReadyHandler=()=>{window.removeEventListener("byd-css-ready",this._cssReadyHandler),this._cssReadyHandler=null,t()},window.addEventListener("byd-css-ready",this._cssReadyHandler)}catch{}}setBMUPower(e){let t=Number(e)||0;this._bmuPower!==t&&(this._bmuPower=t,this._markDirty())}setBMUVersion(e){let t=e??"";this._bmuVersion!==t&&(this._bmuVersion=t,this._markDirty())}setBMSVersion(e){let t=e??"";this._bmsVersion!==t&&(this._bmsVersion=t,this._markDirty())}setUIMeta(e){let t=e??"";this._uiMeta!==t&&(this._uiMeta=t,this._markDirty())}setStateOfCharge(e){let t=Number(e)||0;this._soc!==t&&(this._soc=t,this._markDirty())}setStateOfHealth(e){let t=Number(e)||0;this._soh!==t&&(this._soh=t,this._markDirty())}setTowerCapacityWh(e){this._towerCapacityWh=Number(e)||0,this._updateCapacity(),this._applyResponsive()}setEstimate(e){this._etaText=e||"",this._updateETA()}setProductName(e){this._productName=e||"",this._updateProductName()}setView(e){let t=e==="temperature"?"temperature":"voltage";this._view!==t&&(this._view=t,this._markDirty())}setDisplayUnit(e){let t=e==="V"?"V":"mV";this._displayUnit!==t&&(this._displayUnit=t,this._markDirty())}showVoltage(){this.setView("voltage"),this.dispatchEvent(new CustomEvent("toggle-view",{detail:{view:"voltage"}}))}showTemperature(){this.setView("temperature"),this.dispatchEvent(new CustomEvent("toggle-view",{detail:{view:"temperature"}}))}_render(){let e=this.shadowRoot;if(!e)return;let t=this._soc<=20?"soc-low":this._soc<=80?"soc-mid":"soc-high",i=this._bmuPower<0?"charge":this._bmuPower>0?"discharge":"",s=this._view==="temperature"?"chip":"chip secondary",o=this._view==="voltage"?"chip":"chip secondary",l="chip secondary",a=this._getCurrentHeaderInfoText(),r=Number(this._bmuPower)||0,h=r<0?"Charging":r>0?"Discharging":"Idle",d=`${Math.abs(Math.round(r))} W`,c=e.querySelector(".battery-tower");if(c){c.className=`battery-tower ${t}`;let b=e.querySelector(".header");b&&(b.classList.toggle("charge",this._bmuPower<0),b.classList.toggle("discharge",this._bmuPower>0));let M=e.getElementById("unit"),E=e.getElementById("temp"),w=e.getElementById("viewmode");M&&(M.className=o,M.style.display=this._showVTToggle?"":"none"),E&&(E.className=s,E.style.display=this._showVTToggle?"":"none"),w&&(w.style.display=this._showViewToggle?"":"none");let C=e.getElementById("header_information");C&&(C.innerHTML=a,C.style.display=this._enabledHeaderInfoKeys().length?"":"none",C.style.cursor=this._enabledHeaderInfoKeys().length>1?"pointer":"default");let f=e.querySelector(".power");f&&(f.style.display=this._showPower||this._showETA&&this._etaText?"":"none");let y=e.querySelector(".power .p-label");y&&(y.textContent=h,y.style.display=this._showPower?"":"none");let m=e.querySelector(".power .p-value");m&&(m.textContent=d,m.style.display=this._showPower?"":"none");let u=e.querySelector(".power .p-eta");u&&(u.style.display=this._showETA&&this._etaText?"":"none");let n=e.querySelector(".soc .fill");n&&(n.style.width=`${Math.max(0,Math.min(100,this._soc))}%`);let v=e.querySelector(".soc .label");v&&(v.textContent=`${(Number(this._soc)||0).toLocaleString(void 0,{minimumFractionDigits:1,maximumFractionDigits:1})}%`);let N=e.getElementById("capacity");N&&(N.style.display=this._showProductCapacity?"":"none");let S=e.querySelector(".logo");S&&S.classList.toggle("nobrandInformation",!this._showProductCapacity);let T=e.getElementById("productname");T&&(T.style.display=this._showProductCapacity?"":"none");let D=e.getElementById("unit");D&&(D.textContent=this._displayUnit);let R=e.getElementById("viewmode");R&&(R.textContent=this._moduleView==="minimal"?"Minimal":this._moduleView==="none"?"No Data":"Detailed"),this._updateETA(),this._applyResponsive(),this._updateProductName();return}e.innerHTML=`
      <div class="battery-tower ${t}">
        <div class="header ${i}">
          <div class="row top">
            <div class="logo">
                <div class="brandname">BYD</div>
                <div class="productname" id="productname"></div>
                <div class="capacity" id="capacity"></div>
            </div>
            
            <div class="${o}" id="unit" style="${this._showVTToggle?"":"display:none"}">${this._displayUnit}</div>
            <div class="${s}" id="temp" style="${this._showVTToggle?"":"display:none"}">\xB0C</div>
            <div class="chip secondary" id="viewmode" style="${this._showViewToggle?"":"display:none"}">${this._moduleView==="minimal"?"Minimal":this._moduleView==="none"?"No Data":"Detailed"}</div>
            <div class="versions" id="header_information">${a}</div>
            
            <div class="power"><div class="p-label">${h}</div><div class="p-value">${d}</div><div class="p-eta" id="eta"></div></div>
          </div>
          <div class="row soc-row">
            <div class="soc"><div class="fill" style="width:${Math.max(0,Math.min(100,this._soc))}%"></div><div class="label">${(Number(this._soc)||0).toLocaleString(void 0,{minimumFractionDigits:1,maximumFractionDigits:1})}%</div></div>
          </div>
        </div>
      </div>`;let _=e.getElementById("unit"),p=e.getElementById("temp"),g=e.getElementById("viewmode"),x=e.getElementById("header_information");_?.addEventListener("pointerdown",b=>{b.preventDefault(),b.stopPropagation(),this.showVoltage()}),p?.addEventListener("pointerdown",b=>{b.preventDefault(),b.stopPropagation(),this.showTemperature()}),g?.addEventListener("pointerdown",b=>{b.preventDefault(),b.stopPropagation(),this._showViewToggle&&(this._moduleView=this._moduleView==="minimal"?"detailed":"minimal",this.dispatchEvent(new CustomEvent("toggle-module-view",{detail:{mode:this._moduleView}})),this._markDirty())}),x?.addEventListener("pointerdown",b=>{b.preventDefault(),b.stopPropagation();let M=this._enabledHeaderInfoKeys();if(M.length<=1)return;this._headerInfoIndex=(this._headerInfoIndex+1)%M.length;let E=this.shadowRoot.getElementById("header_information");E&&(E.innerHTML=this._getCurrentHeaderInfoText())}),this._updateCapacity(),this._updateETA(),this._applyResponsive(),this._updateProductName()}_applyResponsive(){let e=this.shadowRoot;if(!e)return;let t=e.getElementById("header_information"),i=this.getBoundingClientRect().width||0;t&&(t.style.display=i<300||this._enabledHeaderInfoKeys().length===0?"none":"")}_setupResizeObserver(){this._ro||(typeof ResizeObserver<"u"?(this._ro=new ResizeObserver(()=>this._applyResponsive()),this._ro.observe(this)):(this._resizeHandler=()=>this._applyResponsive(),window.addEventListener("resize",this._resizeHandler)))}_enabledHeaderInfoKeys(){let e=this._headerInfo?.show||{},t=["versions","ui","energy","efficiency"].filter(i=>e[i]!==!1);return t.length?t:["versions","ui","energy","efficiency"]}_currentHeaderKey(){let e=this._enabledHeaderInfoKeys();if(e.length===0)return"";let t=this._headerInfo?.default||"versions",s=(Math.max(0,e.indexOf(t))+(this._headerInfoIndex||0))%e.length;return e[s]}_getCurrentHeaderInfoText(){let e=this._headerInfo?.payload||{},t=this._enabledHeaderInfoKeys();if(t.length===0)return"";let i=0,s=this._headerInfo?.default||"versions",o=t.indexOf(s);i=o>=0?o:0;let l=(i+this._headerInfoIndex)%t.length,a=t[l];return a==="versions"?e.versionsText||`BMU ${this._bmuVersion||""}<br>BMS ${this._bmsVersion||""}`:a==="ui"?e.uiText||this._uiMeta||"":a==="energy"?e.energyText||"":a==="efficiency"&&e.effText||""}setShowVTToggle(e){let t=e!==!1;this._showVTToggle!==t&&(this._showVTToggle=t,this._markDirty())}setShowViewToggle(e){let t=!!e;this._showViewToggle!==t&&(this._showViewToggle=t,this._markDirty())}setModuleView(e){let t=e==="minimal"?"minimal":e==="none"?"none":"detailed";this._moduleView!==t&&(this._moduleView=t,this._markDirty())}setHeaderInformation(e){if(e&&typeof e=="object"){let t=this._currentHeaderKey();this._headerInfo={default:e.default||"versions",show:e.show||this._headerInfo.show,payload:e.payload||this._headerInfo.payload};let i=this._enabledHeaderInfoKeys(),s=this._headerInfo.default||"versions",o=Math.max(0,i.indexOf(s));if(t&&i.includes(t)){let l=(i.indexOf(t)-o+i.length)%i.length;this._headerInfoIndex=l}else this._headerInfoIndex=0;this._markDirty()}}setHeaderDisplayOptions(e){if(e&&typeof e=="object"){let t=!1;e.showPower!==void 0&&this._showPower!==!!e.showPower&&(this._showPower=!!e.showPower,t=!0),e.showETA!==void 0&&this._showETA!==!!e.showETA&&(this._showETA=!!e.showETA,t=!0),e.showProductCapacity!==void 0&&this._showProductCapacity!==!!e.showProductCapacity&&(this._showProductCapacity=!!e.showProductCapacity,t=!0),t&&this._markDirty()}}_updateCapacity(){let e=this.shadowRoot;if(!e)return;let t=e.getElementById("capacity");if(!t)return;let i=Number(this._towerCapacityWh)||0;if(i>0){let s=i/1e3;t.textContent=`${s.toFixed(1)} kWh`}else t.textContent=""}_updateETA(){let e=this.shadowRoot;if(!e)return;let t=e.getElementById("eta");t&&(t.textContent=this._etaText||"",t.style.display=this._showETA&&this._etaText?"":"none")}_updateProductName(){let e=this.shadowRoot;if(!e)return;let t=e.getElementById("productname");t&&(t.textContent=this._productName||"")}};customElements.get("byd-battery-header")||customElements.define("byd-battery-header",O);var q=class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this._name="BMS",this._view="voltage",this._yAxis=!0,this._voltage=[],this._histMax=[],this._histMin=[],this._temp=[],this._balancing=[],this._chart={vMin:3100,vMax:3700,tMin:0,tMax:60},this._last={voltage:[],temp:[],histMin:[],histMax:[]},this._tip={showUntil:0,x:0,y:0,text:""},this._showGrayCaps=!0,this._displayUnit="mV",this._moduleView="detailed",this._renderScheduled=!1,this._renderFrame=null,this._renderTimeout=null,this._lastRenderTime=0,this._dirty=!0,this._dom=null,this._cellElements=[],this._tooltipTimer=null,this._cssReadyHandler=null,this._chartEventHandlers=null}connectedCallback(){this._scheduleRender(),this._adoptCss(),this._visibilityHandler&&document.removeEventListener("visibilitychange",this._visibilityHandler),this._visibilityHandler=()=>{document.visibilityState==="visible"&&this._dirty&&(this._renderScheduled=!1,this._scheduleRender())},document.addEventListener("visibilitychange",this._visibilityHandler)}disconnectedCallback(){this._renderTimeout&&(clearTimeout(this._renderTimeout),this._renderTimeout=null),this._renderFrame&&(cancelAnimationFrame(this._renderFrame),this._renderFrame=null),this._tooltipTimer&&(clearTimeout(this._tooltipTimer),this._tooltipTimer=null),this._cssReadyHandler&&(window.removeEventListener("byd-css-ready",this._cssReadyHandler),this._cssReadyHandler=null),this._visibilityHandler&&(document.removeEventListener("visibilitychange",this._visibilityHandler),this._visibilityHandler=null),this._dom?.chart&&this._chartEventHandlers&&(this._dom.chart.removeEventListener("pointermove",this._chartEventHandlers.pointermove),this._dom.chart.removeEventListener("pointerleave",this._chartEventHandlers.pointerleave),this._dom.chart.removeEventListener("pointerdown",this._chartEventHandlers.pointerdown),this._chartEventHandlers=null),this._renderScheduled=!1,this._dom=null,this._cellElements=[]}_adoptCss(){try{if(this._sheet||!this.shadowRoot)return;let e=typeof globalThis<"u"?globalThis:typeof window<"u"?window:void 0,t=()=>{let i=e&&e.__BYD_CSS_SHEET;i&&(this.shadowRoot.adoptedStyleSheets=[i],this._sheet=i)};if(e&&e.__BYD_CSS_SHEET){t();return}this._cssReadyHandler=()=>{window.removeEventListener("byd-css-ready",this._cssReadyHandler),this._cssReadyHandler=null,t()},window.addEventListener("byd-css-ready",this._cssReadyHandler)}catch{}}_markDirty(){this._dirty=!0,document.visibilityState==="visible"&&(this._renderScheduled&&!this._hasRenderedOnce&&(this._renderTimeout&&(clearTimeout(this._renderTimeout),this._renderTimeout=null),this._renderFrame&&(cancelAnimationFrame(this._renderFrame),this._renderFrame=null),this._renderScheduled=!1),this._scheduleRender())}_scheduleRender(){if(this._renderScheduled)return;if(this._renderScheduled=!0,!this._hasRenderedOnce){this._renderFrame=requestAnimationFrame(()=>this._doRender());return}let t=performance.now()-this._lastRenderTime;t>=500?this._renderFrame=requestAnimationFrame(()=>this._doRender()):this._renderTimeout=setTimeout(()=>{this._renderTimeout=null,this._renderFrame=requestAnimationFrame(()=>this._doRender())},500-t)}_doRender(){this._renderScheduled=!1,this._lastRenderTime=performance.now(),this._dirty&&(this._dirty=!1,this._render(),this._hasRenderedOnce=!0)}setVoltage(e){this._setArray("voltage",e)}setHistoryMaxVoltage(e){this._setArray("histMax",e)}setHistoryMinVoltage(e){this._setArray("histMin",e)}setChartMaxVoltage(e){let t=Number(e)||this._chart.vMax;this._chart.vMax!==t&&(this._chart.vMax=t,this._markDirty())}setChartMinVoltage(e){let t=Number(e)||this._chart.vMin;this._chart.vMin!==t&&(this._chart.vMin=t,this._markDirty())}setTemperature(e){this._setArray("temp",e)}setChartMaxTemperature(e){let t=Number(e)||this._chart.tMax;this._chart.tMax!==t&&(this._chart.tMax=t,this._markDirty())}setChartMinTemperature(e){let t=Number(e)||this._chart.tMin;this._chart.tMin!==t&&(this._chart.tMin=t,this._markDirty())}setCellBallancing(e){let t=Array.isArray(e)?e:[];this._arraysEqual(this._balancing,t)||(this._balancing=t,this._markDirty())}setShowGrayCaps(e){let t=e!==!1;this._showGrayCaps!==t&&(this._showGrayCaps=t,this._markDirty())}setDisplayUnit(e){let t=e==="V"?"V":"mV";this._displayUnit!==t&&(this._displayUnit=t,this._markDirty())}setModuleView(e){let t=e==="minimal"?"minimal":e==="none"?"none":"detailed";this._moduleView!==t&&(this._moduleView=t,this._dom=null,this._markDirty())}setStateOfCharge(){}setStateOfHealth(){}setEfficiency(){}setBMUPower(){}setBMUVersion(){}setBMSVersion(){}showVoltage(){this._view!=="voltage"&&(this._view="voltage",this._dom=null,this._markDirty())}showTemperature(){this._view!=="temperature"&&(this._view="temperature",this._dom=null,this._markDirty())}showYAxisValues(){this._yAxis||(this._yAxis=!0,this._dom=null,this._markDirty())}hideYAxisValues(){this._yAxis&&(this._yAxis=!1,this._dom=null,this._markDirty())}set name(e){this._name!==e&&(this._name=e,this._dom?.nameEl?this._dom.nameEl.textContent=e||"":this._scheduleRender())}get name(){return this._name}_arraysEqual(e,t){if(!Array.isArray(e)||!Array.isArray(t))return e===t;if(e.length!==t.length)return!1;for(let i=0;i<e.length;i++)if(e[i]!==t[i])return!1;return!0}_setArray(e,t){let i=e==="voltage"?"voltage":e==="histMax"?"histMax":e==="histMin"?"histMin":e;if(!Array.isArray(t))return;let s=this["_"+i],o=t.map(a=>Number(a)),l=s.map(a=>Number(a));this._arraysEqual(l,o)||(t=o,i==="voltage"&&(this._last.voltage=this._voltage.slice()),i==="temp"&&(this._last.temp=this._temp.slice()),i==="histMin"&&(this._last.histMin=this._histMin.slice()),i==="histMax"&&(this._last.histMax=this._histMax.slice()),this["_"+i]=t.slice(),this._markDirty())}_getAxis(){if(this._view==="temperature")return{min:this._chart.tMin,max:this._chart.tMax,unit:"\xB0C"};let e=this._chart.vMin??Math.min(...this._histMin,...this._voltage),t=this._chart.vMax??Math.max(...this._histMax,...this._voltage),i=this._displayUnit==="V"?"V":"mV";return{min:e,max:t,unit:i}}_render(){let e=this.shadowRoot;if(e){if(this._moduleView==="none"){(!this._dom||this._dom.type!=="none")&&(e.innerHTML='<div class="battery-module nodata no-axis"><div class="module-name"></div></div>',this._dom={type:"none",nameEl:e.querySelector(".module-name")}),this._dom.nameEl.textContent=this._name||"";return}if(this._moduleView==="minimal"){this._renderMinimal(e);return}this._renderDetailed(e)}}_renderMinimal(e){let t=this._voltage.filter(f=>Number.isFinite(Number(f))).map(Number),i=this._temp.filter(f=>Number.isFinite(Number(f))).map(Number),s=f=>{if(!f.length)return 0;let y=[...f].sort((u,n)=>u-n),m=Math.floor(y.length/2);return y.length%2?y[m]:(y[m-1]+y[m])/2},o=s(t),l=s(this._histMin.filter(f=>Number.isFinite(Number(f))).map(Number)),a=s(this._histMax.filter(f=>Number.isFinite(Number(f))).map(Number)),r=s(i),h=f=>{let y=this._chart.vMin,m=this._chart.vMax;return!Number.isFinite(f)||m===y?0:(Math.min(m,Math.max(y,Number(f)))-y)/(m-y)*100},d=f=>{let y=this._chart.tMin,m=this._chart.tMax;return!Number.isFinite(f)||m===y?0:(Math.min(m,Math.max(y,Number(f)))-y)/(m-y)*100},c=0;Math.max(0,o-l)<20&&(c=150);let _=f=>this._displayUnit==="V"?`${(Number(f)/1e3).toLocaleString(void 0,{minimumFractionDigits:3,maximumFractionDigits:3})} V`:`${Math.round(Number(f))} mV`,p=h(l-c),g=h(o),x=Math.max(0,g-p),b=p+x/2,M=this._balancing?.some(f=>f===1||f===!0),E=(this._balancing||[]).filter(f=>f===1||f===!0).length;(!this._dom||this._dom.type!=="minimal")&&(e.innerHTML=`
        <div class="battery-module minimal no-axis">
          <div class="mini">
            <div class="mini-row">
              <div class="mini-label">Voltage</div>
              <div class="hbar">
                <div class="hseg greencap" data-el="vBase"></div>
                <div class="hseg cur" data-el="vCur"></div>
                <div class="hseg max" data-el="vMax"></div>
                <div class="hnum" data-el="vNum" style="color:#fff;"></div>
              </div>
            </div>
            <div class="mini-row">
              <div class="mini-label">Temperature</div>
              <div class="hbar">
                <div class="hseg cur" data-el="tCur"></div>
                <div class="hnum" data-el="tNum" style="color:#fff;"></div>
              </div>
            </div>
            <div class="mini-row">
              <div class="mini-label">Cell Balancing</div>
              <div class="mini-stat" data-el="balStat"></div>
            </div>
          </div>
          <div class="module-name" data-el="name"></div>
        </div>
      `,this._dom={type:"minimal",vBase:e.querySelector('[data-el="vBase"]'),vCur:e.querySelector('[data-el="vCur"]'),vMax:e.querySelector('[data-el="vMax"]'),vNum:e.querySelector('[data-el="vNum"]'),tCur:e.querySelector('[data-el="tCur"]'),tNum:e.querySelector('[data-el="tNum"]'),balStat:e.querySelector('[data-el="balStat"]'),nameEl:e.querySelector('[data-el="name"]')});let w=this._dom;w.vBase.className=`hseg ${M?"bluecap":"greencap"}`,w.vBase.style.cssText=`left:0;width:${Math.max(0,h(l))}%;`,w.vCur.className=`hseg cur${M?" bal":""}`,w.vCur.style.cssText=`left:${p}%;width:${x}%;`,w.vMax.style.cssText=this._showGrayCaps?`left:${g}%;width:${Math.max(0,h(a)-g)}%;`:"display:none;",w.vNum.style.left=`${b}%`,w.vNum.textContent=_(o);let C=Math.max(0,d(r));w.tCur.style.cssText=`left:0;width:${C}%;`,w.tNum.style.left=`${C/2}%`,w.tNum.textContent=`${Number(r).toLocaleString(void 0,{maximumFractionDigits:1})} \xB0C`,w.balStat.textContent=E,w.nameEl.textContent=this._name||""}_renderDetailed(e){let t=this._getAxis(),i=this._view==="temperature",s=i?this._temp:this._voltage,o=s.length,l=t.max,a=t.min,r=_=>_==null||isNaN(_)||l===a?0:(Math.min(l,Math.max(a,Number(_)))-a)/(l-a)*100,h=_=>i?`${Number(_).toLocaleString(void 0,{maximumFractionDigits:1})} \xB0C`:this._displayUnit==="V"?`${(Number(_)/1e3).toLocaleString(void 0,{minimumFractionDigits:3,maximumFractionDigits:3})} V`:`${Math.round(Number(_))} mV`,d=0;if(!i){let _=[];for(let g=0;g<o;g++){let x=Number(this._voltage[g]),b=Number(this._histMin[g]);Number.isFinite(x)&&Number.isFinite(b)&&_.push(Math.max(0,x-b))}(_.length?_.reduce((g,x)=>g+x,0)/_.length:0)<20&&(d=150)}(!this._dom||this._dom.type!=="detailed"||this._dom.cellCount!==o||this._dom.isTemp!==i)&&this._buildDetailedDOM(e,o,i,t),this._updateDetailedValues(s,o,i,r,h,d,a,l,t)}_buildDetailedDOM(e,t,i,s){e.innerHTML=`
      <div class="battery-module ${this._yAxis?"":"no-axis"}">
        <div class="axis" style="display:${this._yAxis?"block":"none"}"></div>
        <div class="chart">
          <div class="tooltip" style="display:none"></div>
          ${this._yAxis?'<div class="grid-lines"></div>':""}
          <div class="cells"></div>
        </div>
        <div class="module-name"></div>
      </div>
    `;let o=e.querySelector(".axis"),l=e.querySelector(".chart"),a=e.querySelector(".cells"),r=e.querySelector(".tooltip"),h=e.querySelector(".grid-lines"),d=e.querySelector(".module-name");if(h&&this._yAxis)for(let _=0;_<=5;_++){let p=_/5,g=document.createElement("div");g.className="line",g.style.top=`${(1-p)*100}%`,h.appendChild(g)}this._cellElements=[];for(let c=0;c<t;c++){let _=document.createElement("div");if(_.className="cell",!i){let g=document.createElement("div");g.className="bar greencap",g.dataset.role="bottomCap",_.appendChild(g);let x=document.createElement("div");x.className="bar max",x.dataset.role="maxCap",_.appendChild(x)}let p=document.createElement("div");p.className="bar cur",p.dataset.role="cur",_.appendChild(p),a.appendChild(_),this._cellElements.push({cell:_,cur:p,bottomCap:_.querySelector('[data-role="bottomCap"]'),maxCap:_.querySelector('[data-role="maxCap"]')})}this._setupTooltipEvents(l,r,t),this._yAxis&&this._renderAxis(o,s),this._dom={type:"detailed",cellCount:t,isTemp:i,axisEl:o,chart:l,cellsWrap:a,tooltip:r,nameEl:d}}_setupTooltipEvents(e,t,i){let s=this._view==="temperature",o=r=>s?`${Number(r).toLocaleString(void 0,{maximumFractionDigits:1})} \xB0C`:this._displayUnit==="V"?`${(Number(r)/1e3).toLocaleString(void 0,{minimumFractionDigits:3,maximumFractionDigits:3})} V`:`${Math.round(Number(r))} mV`,l=()=>{t._sticky||(t.style.display="none")},a=(r,h,d)=>Math.max(h,Math.min(d,r));this._chartEventHandlers={pointermove:r=>{let h=e.getBoundingClientRect(),d=h.width-12,c=a((r.clientX-h.left-6)/(d||1),0,1),_=a(Math.floor(c*i),0,i-1),g=(this._view==="temperature"?this._temp:this._voltage)[_];t.style.display="block",t.textContent=o(g);let x=t.offsetWidth||50,b=t.offsetHeight||20,M=r.clientX-h.left+10,E=r.clientY-h.top-10-b;M=a(M,6,h.width-x-6),E=a(E,6,h.height-b-6),t.style.left=`${M}px`,t.style.top=`${E}px`,this._tip.x=M,this._tip.y=E,this._tip.text=o(g)},pointerleave:l,pointerdown:r=>{t.style.display="block",t._sticky=!0,this._tip.showUntil=Date.now()+3e3,this._tooltipTimer&&clearTimeout(this._tooltipTimer),this._tooltipTimer=setTimeout(()=>{t._sticky=!1,this._tip.showUntil=0,l()},3e3)}},e.addEventListener("pointermove",this._chartEventHandlers.pointermove),e.addEventListener("pointerleave",this._chartEventHandlers.pointerleave),e.addEventListener("pointerdown",this._chartEventHandlers.pointerdown)}_updateDetailedValues(e,t,i,s,o,l,a,r,h){if(!this._dom||!this._cellElements.length)return;let d=this._dom;d.nameEl.textContent=this._name||"";for(let c=0;c<t;c++){let _=Number(e[c]),p=this._cellElements[c];if(!p)continue;let g=a,x=r;if(!i){let f=Number(this._histMin[c]),y=Number(this._histMax[c]);if(Number.isFinite(f)&&(g=f),Number.isFinite(y)&&(x=y),p.bottomCap){let u=this._balancing&&(this._balancing[c]===!0||this._balancing[c]===1);p.bottomCap.className="bar "+(u?"bluecap":"greencap"),Number.isFinite(g)&&g>a?(p.bottomCap.style.height=s(g)+"%",p.bottomCap.style.display=""):p.bottomCap.style.display="none"}if(p.maxCap){let u=s(_);if(this._showGrayCaps&&Number.isFinite(x)){let n=s(x),v=Math.max(0,n-u);v>0?(p.maxCap.style.bottom=u+"%",p.maxCap.style.height=v+"%",p.maxCap.style.display=""):p.maxCap.style.display="none"}else p.maxCap.style.display="none"}let m=this._balancing&&(this._balancing[c]===!0||this._balancing[c]===1);p.cell.classList.toggle("balancing",m)}let b=s(_),M=s(g-l),E=Math.max(0,b-M),w=i?this._last.temp[c]:this._last.voltage[c];if(w!==void 0&&!Number.isNaN(Number(w))){let f=0,y=0;if(i)f=0,y=Math.max(0,s(Number(w)));else{let m=g,u=Number(this._last.histMin[c]);Number.isFinite(u)&&(m=u);let n=s(m-l),v=s(Number(w));f=n,y=Math.max(0,v-n)}p.cur.style.transition="none",p.cur.style.bottom=f+"%",p.cur.style.height=y+"%",requestAnimationFrame(()=>{p.cur.style.transition="height .6s ease, bottom .6s ease",p.cur.style.bottom=M+"%",p.cur.style.height=E+"%"})}else p.cur.style.bottom=M+"%",p.cur.style.height=E+"%"}if(this._tip?.showUntil&&Date.now()<this._tip.showUntil&&d.tooltip){d.tooltip.style.display="block",d.tooltip.textContent=this._tip.text||"";let c=d.chart.getBoundingClientRect(),_=d.tooltip.offsetWidth||50,p=d.tooltip.offsetHeight||20,g=this._tip.x,x=this._tip.y;g=Math.max(6,Math.min(g,c.width-_-6)),x=Math.max(6,Math.min(x,c.height-p-6)),d.tooltip.style.left=`${g}px`,d.tooltip.style.top=`${x}px`,d.tooltip._sticky=!0}}_renderAxis(e,t){e.innerHTML="";let i=5;for(let s=0;s<=i;s++){let o=s/i,l=document.createElement("div");l.className="tick",l.style.top=`${(1-o)*100}%`;let a=document.createElement("div");a.className="label";let r=t.min+(t.max-t.min)*o,h;t.unit==="\xB0C"?h=`${Number(r).toLocaleString(void 0,{maximumFractionDigits:1})} ${t.unit}`:t.unit==="V"?h=`${(Number(r)/1e3).toLocaleString(void 0,{minimumFractionDigits:3,maximumFractionDigits:3})} V`:h=`${Math.round(Number(r))} mV`,a.textContent=h,a.style.top=`${(1-o)*100}%`,e.appendChild(l),e.appendChild(a)}}};customElements.get("byd-battery-module")||customElements.define("byd-battery-module",q);var Y=class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this._cssReadyHandler=null}connectedCallback(){this._render(),this._adoptCss()}disconnectedCallback(){this._cssReadyHandler&&(window.removeEventListener("byd-css-ready",this._cssReadyHandler),this._cssReadyHandler=null),this._sheet=null}_adoptCss(){try{let e=typeof globalThis<"u"?globalThis:typeof window<"u"?window:void 0;if(this._sheet||!this.shadowRoot)return;let t=()=>{let i=e&&e.__BYD_CSS_SHEET;i&&(this.shadowRoot.adoptedStyleSheets=[i],this._sheet=i)};if(e&&e.__BYD_CSS_SHEET){t();return}this._cssReadyHandler=()=>{window.removeEventListener("byd-css-ready",this._cssReadyHandler),this._cssReadyHandler=null,t()},window.addEventListener("byd-css-ready",this._cssReadyHandler)}catch{}}_render(){this.shadowRoot.innerHTML='<div class="battery-stand"><div class="foot left"></div><div class="foot right"></div></div>'}};customElements.get("byd-battery-stand")||customElements.define("byd-battery-stand",Y);var Q=500,W=class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this._index=Number(this.getAttribute("index"))||1,this._modules=2,this._header=null,this._moduleEls=[],this._chartV={min:3100,max:3700},this._chartT={min:0,max:60},this._view="voltage",this._displayUnit="mV",this._moduleView="detailed",this._pendingData={voltage:null,histMax:null,histMin:null,balancing:null,temps:null},this._renderScheduled=!1,this._renderFrame=null,this._renderTimeout=null,this._lastRenderTime=0,this._cssReadyHandler=null,this._dirty=!0}connectedCallback(){this._scheduleRender(),this._adoptCss(),this._visibilityHandler&&document.removeEventListener("visibilitychange",this._visibilityHandler),this._visibilityHandler=()=>{document.visibilityState==="visible"&&this._dirty&&(this._renderScheduled=!1,this._scheduleRender())},document.addEventListener("visibilitychange",this._visibilityHandler)}_markDirty(){this._dirty=!0,document.visibilityState==="visible"&&this._scheduleRender()}disconnectedCallback(){this._renderTimeout&&(clearTimeout(this._renderTimeout),this._renderTimeout=null),this._renderFrame&&(cancelAnimationFrame(this._renderFrame),this._renderFrame=null),this._cssReadyHandler&&(window.removeEventListener("byd-css-ready",this._cssReadyHandler),this._cssReadyHandler=null),this._visibilityHandler&&(document.removeEventListener("visibilitychange",this._visibilityHandler),this._visibilityHandler=null),this._renderScheduled=!1}_scheduleRender(){if(this._renderScheduled)return;this._renderScheduled=!0;let t=performance.now()-this._lastRenderTime;t>=Q?this._renderFrame=requestAnimationFrame(()=>this._doRender()):this._renderTimeout=setTimeout(()=>{this._renderTimeout=null,this._renderFrame=requestAnimationFrame(()=>this._doRender())},Q-t)}_doRender(){this._renderScheduled=!1,this._lastRenderTime=performance.now(),this._dirty&&(this._dirty=!1,this._render())}_adoptCss(){try{let e=typeof globalThis<"u"?globalThis:typeof window<"u"?window:void 0;if(this._sheet||!this.shadowRoot)return;let t=()=>{let i=e&&e.__BYD_CSS_SHEET;i&&(this.shadowRoot.adoptedStyleSheets=[i],this._sheet=i)};if(e&&e.__BYD_CSS_SHEET){t();return}this._cssReadyHandler=()=>{window.removeEventListener("byd-css-ready",this._cssReadyHandler),this._cssReadyHandler=null,t()},window.addEventListener("byd-css-ready",this._cssReadyHandler)}catch{}}setModules(e){let t=Math.max(2,Math.min(10,Number(e)||2));this._modules!==t&&(this._modules=t,this._initialModulesSet?this._markDirty():(this._initialModulesSet=!0,this._dirty=!0,this._renderScheduled=!0,this._render(),this._renderScheduled=!1,this._lastRenderTime=performance.now()))}getModulesCount(){return this._modules}setVoltage(e){this._pendingData.voltage=e,this._eachModuleData(e,(t,i)=>t.setVoltage(i))}setHistoryMaxVoltage(e){this._pendingData.histMax=e,this._eachModuleData(e,(t,i)=>t.setHistoryMaxVoltage(i))}setHistoryMinVoltage(e){this._pendingData.histMin=e,this._eachModuleData(e,(t,i)=>t.setHistoryMinVoltage(i))}setChartMaxVoltage(e){this._chartV.max=Number(e)||this._chartV.max,this._moduleEls.forEach(t=>t.setChartMaxVoltage(this._chartV.max))}setChartMinVoltage(e){this._chartV.min=Number(e)||this._chartV.min,this._moduleEls.forEach(t=>t.setChartMinVoltage(this._chartV.min))}setTemperature(e){this._pendingData.temps=e,this._eachModuleData(e,(t,i)=>t.setTemperature(i))}setChartMaxTemperature(e){this._chartT.max=Number(e)||this._chartT.max,this._moduleEls.forEach(t=>t.setChartMaxTemperature(this._chartT.max))}setChartMinTemperature(e){this._chartT.min=Number(e)||this._chartT.min,this._moduleEls.forEach(t=>t.setChartMinTemperature(this._chartT.min))}setCellBallancing(e){this._pendingData.balancing=e,this._eachModuleData(e,(t,i)=>t.setCellBallancing(i))}setStateOfCharge(e){this._header?.setStateOfCharge(e)}setStateOfHealth(e){this._header?.setStateOfHealth(e)}setEfficiency(e){}setBMUPower(e){this._header?.setBMUPower(e)}setBMUVersion(e){this._header?.setBMUVersion(e)}setBMSVersion(e){this._header?.setBMSVersion(e)}setUIMeta(e){this._header?.setUIMeta?.(e)}setTowerCapacityWh(e){this._header?.setTowerCapacityWh?.(e)}setEstimate(e){this._header?.setEstimate?.(e)}setProductName(e){this._header?.setProductName?.(e)}setDisplayUnit(e){this._displayUnit=e==="V"?"V":"mV",this._header?.setDisplayUnit?.(this._displayUnit),this._moduleEls.forEach(t=>t.setDisplayUnit?.(this._displayUnit))}setModuleView(e){this._moduleView=e==="minimal"?"minimal":e==="none"?"none":"detailed",this._header?.setModuleView?.(this._moduleView),this._moduleEls.forEach(t=>t.setModuleView?.(this._moduleView))}getModuleView(){return this._moduleView}setHeaderInformation(e){this._header?.setHeaderInformation?.(e)}setShowVTToggle(e){this._header?.setShowVTToggle?.(e)}setShowViewToggle(e){this._header?.setShowViewToggle?.(e)}showVoltage(){this._view="voltage",this._header?.setView?.("voltage"),this._moduleEls.forEach(e=>e.showVoltage())}showTemperature(){this._view="temperature",this._header?.setView?.("temperature"),this._moduleEls.forEach(e=>e.showTemperature())}getView(){return this._view}showYAxisValues(){this._moduleEls.forEach(e=>e.showYAxisValues())}hideYAxisValues(){this._moduleEls.forEach(e=>e.hideYAxisValues())}setShowGrayCaps(e){this._moduleEls.forEach(t=>t.setShowGrayCaps?.(e))}setHeaderDisplayOptions(e){this._header?.setHeaderDisplayOptions?.(e)}_eachModuleData(e,t){if(e&&Array.isArray(e))if(e.length&&typeof e[0]=="object"&&!Array.isArray(e[0]))for(let i of e){let s=(i.m||i.module||1)-1,o=this._moduleEls[s];o&&t(o,i.v||i.t||i.b||[])}else for(let i=0;i<Math.min(this._moduleEls.length,e.length);i++)t(this._moduleEls[i],e[i]||[])}_render(){let e=this.shadowRoot;if(!e)return;e.innerHTML=`
      <div class="battery-tower">
        <byd-battery-header></byd-battery-header>
        <div class="modules"></div>
        <byd-battery-stand></byd-battery-stand>
      </div>
    `,this._header=e.querySelector("byd-battery-header"),this._header.addEventListener("toggle-view",s=>{s.detail.view==="temperature"?this.showTemperature():this.showVoltage()}),this._header.addEventListener("toggle-unit",s=>{this.setDisplayUnit(s.detail?.unit)}),this._header.addEventListener("toggle-module-view",s=>{this.setModuleView(s.detail?.mode)});let t=e.querySelector(".modules");t.innerHTML="",this._moduleEls=[];let i=this._modules;for(let s=0;s<i;s++){let o=document.createElement("byd-battery-module");o.name=`BMS ${this._index}.${s+1}`,o.setChartMinVoltage(this._chartV.min),o.setChartMaxVoltage(this._chartV.max),o.setChartMinTemperature(this._chartT.min),o.setChartMaxTemperature(this._chartT.max),o.setDisplayUnit?.(this._displayUnit),o.setModuleView?.(this._moduleView),t.appendChild(o),this._moduleEls.push(o)}this._pendingData.voltage&&this._eachModuleData(this._pendingData.voltage,(s,o)=>s.setVoltage(o)),this._pendingData.histMax&&this._eachModuleData(this._pendingData.histMax,(s,o)=>s.setHistoryMaxVoltage(o)),this._pendingData.histMin&&this._eachModuleData(this._pendingData.histMin,(s,o)=>s.setHistoryMinVoltage(o)),this._pendingData.balancing&&this._eachModuleData(this._pendingData.balancing,(s,o)=>s.setCellBallancing(o)),this._pendingData.temps&&this._eachModuleData(this._pendingData.temps,(s,o)=>s.setTemperature(o)),this._pendingData={voltage:null,histMax:null,histMin:null,balancing:null,temps:null}}};customElements.get("byd-battery-tower")||customElements.define("byd-battery-tower",W);var re=new URL("../styles/battery.css?v=0.0.7",import.meta.url),Z=500,G=class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this._towers=1,this._towerEls=[],this._renderScheduled=!1,this._renderFrame=null,this._renderTimeout=null,this._lastRenderTime=0,this._dirty=!0}connectedCallback(){this._scheduleRender(),this._ensureCss(),this._visibilityHandler&&document.removeEventListener("visibilitychange",this._visibilityHandler),this._visibilityHandler=()=>{document.visibilityState==="visible"&&this._dirty&&(this._renderScheduled=!1,this._scheduleRender())},document.addEventListener("visibilitychange",this._visibilityHandler)}disconnectedCallback(){this._renderTimeout&&(clearTimeout(this._renderTimeout),this._renderTimeout=null),this._renderFrame&&(cancelAnimationFrame(this._renderFrame),this._renderFrame=null),this._visibilityHandler&&(document.removeEventListener("visibilitychange",this._visibilityHandler),this._visibilityHandler=null),this._renderScheduled=!1}_markDirty(){this._dirty=!0,document.visibilityState==="visible"&&this._scheduleRender()}_scheduleRender(){if(this._renderScheduled)return;this._renderScheduled=!0;let t=performance.now()-this._lastRenderTime;t>=Z?this._renderFrame=requestAnimationFrame(()=>this._doRender()):this._renderTimeout=setTimeout(()=>{this._renderTimeout=null,this._renderFrame=requestAnimationFrame(()=>this._doRender())},Z-t)}_doRender(){this._renderScheduled=!1,this._lastRenderTime=performance.now(),this._dirty&&(this._dirty=!1,this._render())}async _ensureCss(){if(!this._sheet)try{let e=typeof globalThis<"u"?globalThis:typeof window<"u"?window:void 0,t=e&&e.__BYD_CSS_SHEET;if(!t){let i=e&&e.__BYD_CSS_TEXT?e.__BYD_CSS_TEXT:await fetch(re).then(s=>s.text());t=new CSSStyleSheet,await t.replace(i),e&&(e.__BYD_CSS_SHEET=t);try{window.dispatchEvent(new Event("byd-css-ready"))}catch{}}this.shadowRoot.adoptedStyleSheets=[t],this._sheet=t}catch{}}setTowers(e){let t=Math.max(1,Math.min(3,Number(e)||1));this._towers!==t&&(this._towers=t,this._initialTowersSet?this._markDirty():(this._initialTowersSet=!0,this._dirty=!0,this._renderScheduled=!0,this._render(),this._renderScheduled=!1,this._lastRenderTime=performance.now()))}getTower(e){return this._towerEls[e-1]}setStateOfCharge(e){this._towerEls.forEach(t=>t?.setStateOfCharge(e))}setStateOfHealth(e){this._towerEls.forEach(t=>t?.setStateOfHealth(e))}setBMUPower(e){this._towerEls.forEach(t=>t?.setBMUPower(e))}setBMUVersion(e){this._towerEls.forEach(t=>t?.setBMUVersion(e))}_render(){let e=this.shadowRoot;if(!e)return;let t=document.createElement("div");t.style.display="grid",t.style.gridTemplateColumns="1fr",t.style.gap="14px",t.style.width="100%",e.innerHTML="",e.appendChild(t),this._towerEls=[];for(let i=0;i<this._towers;i++){let s=document.createElement("byd-battery-tower");s.setAttribute("index",String(i+1)),t.appendChild(s),this._towerEls.push(s)}}};customElements.get("byd-battery-system")||customElements.define("byd-battery-system",G);var ee="0.0.6",I=class extends HTMLElement{static getConfigElement(){return document.createElement("byd-battery-box-visualization-editor")}static getStubConfig(){return{voltage_auto:!0,temp_min:10,temp_max:45,show_y_axis:!0,show_gray_caps:!0,unit:"mV",default_view:"voltage",module_view:"detailed",show_vt_toggle:!0,show_view_toggle:!1,show_power:!0,show_eta:!0,show_product_capacity:!0,header_information_default:"versions",show_header_versions:!0,show_header_ui:!0,show_header_energy:!0,show_header_efficiency:!0}}setConfig(e){this._config=e||{}}set hass(e){let t=this._hass;if(this._hass=e,this._renderCount=(this._renderCount||0)+1,this._renderCount<=5){this._render();return}let i=/^sensor\.(bmu_|bms_|total_capacity)/,s=t?.states||{},o=e.states||{},l=!1;for(let a of Object.keys(o))if(i.test(a)){let r=s[a],h=o[a];if(!r||r.state!==h.state||r.last_updated!==h.last_updated){l=!0;break}}l&&this._render()}getCardSize(){return 8}disconnectedCallback(){this._visibilityHandler&&(document.removeEventListener("visibilitychange",this._visibilityHandler),this._visibilityHandler=null),this._sampleInterval&&(clearInterval(this._sampleInterval),this._sampleInterval=null),this._powerSamples=null,this._entities=null,this._devices=null}_pushPowerSample(e){let t=Date.now();this._powerSamples=this._powerSamples||[],this._powerSamples.push({t,p:Number(e)||0});let i=t-5*60*1e3;for(;this._powerSamples.length&&this._powerSamples[0].t<i;)this._powerSamples.shift()}_avgPowerW(){let e=this._powerSamples||[];if(e.length===0)return 0;let t=Date.now(),i=0,s=0;for(let o=0;o<e.length;o++){let l=e[o],a=e[o+1]||{t,p:l.p},r=Math.max(0,a.t-l.t);r>0&&(i+=l.p*r,s+=r)}return s>0?i/s:e[e.length-1].p}_render(){if(!this._hass)return;let e=this._config||{},t=this.shadowRoot||this.attachShadow({mode:"open"});if(!this._el){let m=document.createElement("style");m.textContent=`
        :host { display: block; }
        ha-card { }
        .byd-container { padding: 10px; }
      `,t.appendChild(m);let u=document.createElement("ha-card"),n=document.createElement("div");n.className="byd-container";let v=document.createElement("byd-battery-system");n.appendChild(v),u.appendChild(n),t.appendChild(u),this._el={card:u,container:n,system:v},this._lastTowerCount=0,this._lastModules=[]}let i=this._discoverTowers(),s=i.length||1;this._lastTowerCount!==s&&(this._el.system.setTowers(s),this._lastTowerCount=s,this._lastModules=new Array(s).fill(void 0));let o=this._discoverBMU();this._pushPowerSample(o.power??0);let l=this._avgPowerW(),a=m=>{let u=Number(m);return Number.isFinite(u)?u:void 0},r=e.voltage_auto!==!1,h=r?void 0:a(e.voltage_min),d=r?void 0:a(e.voltage_max),c=a(e.temp_min),_=a(e.temp_max),p=i.length?Math.min(...i.map(m=>m?.chart?.vMin??99999)):3100,g=i.length?Math.max(...i.map(m=>m?.chart?.vMax??-99999)):3500,x=h!==void 0?h:p,b=d!==void 0?d:g;if(d===void 0){let m=Number(this._discoverBMU().cellMaxV||0),u=Math.max(3500,m>3.5?Math.round(m*1e3):0);u>0&&(b=Math.min(b,u))}let M=c!==void 0?c:0,E=_!==void 0?_:60,w=o.totalCapacityWh&&s?o.totalCapacityWh/s:0,C=m=>{if(!Number.isFinite(m)||m<=0)return"";let u=Math.floor(m/3600),n=Math.round(m%3600/60);return u>0?`${u}h ${n}m`:`${n}m`},y=(e.unit||"mV")==="V"?"V":"mV";if(this._appliedInitialView!==!0){let m=e.default_view==="temperature"?"temperature":"voltage";this._currentView=m,this._appliedInitialView=!0}for(let m=0;m<s;m++){let u=i[m],n=this._el.system.getTower(m+1);if(!n||!u)continue;if(m===0&&typeof n.getView=="function"&&this._lastAppliedView!==void 0){let V=n.getView();(V==="temperature"||V==="voltage")&&(this._currentView=V)}if(this._lastAppliedModuleView===void 0){if(this._appliedInitialModuleView!==!0){let V=e.module_view;this._currentModuleView=V==="minimalistic"||V==="minimal"?"minimal":V==="no-data"||V==="none"?"none":"detailed",this._appliedInitialModuleView=!0}typeof n.setModuleView=="function"&&(n.setModuleView(this._currentModuleView),this._lastAppliedModuleView=this._currentModuleView)}if((typeof n.getModulesCount=="function"?Number(n.getModulesCount()):this._lastModules[m]??0)!==u.modules&&(n.setModules(u.modules),this._lastModules[m]=u.modules,typeof n.setModuleView=="function"&&n.setModuleView(this._currentModuleView)),n.setChartMinVoltage(x),n.setChartMaxVoltage(b),n.setChartMinTemperature(M),n.setChartMaxTemperature(E),e.show_y_axis===!1?n.hideYAxisValues():n.showYAxisValues(),typeof n.setShowGrayCaps=="function"&&n.setShowGrayCaps(e.show_gray_caps!==!1),this._appliedInitialModuleView!==!0){let V=e.module_view;this._currentModuleView=V==="minimalistic"||V==="minimal"?"minimal":V==="no-data"||V==="none"?"none":"detailed",this._appliedInitialModuleView=!0}if(typeof n.getModuleView=="function"&&this._lastAppliedModuleView!==void 0){let V=n.getModuleView();(V==="minimal"||V==="detailed"||V==="none")&&(this._currentModuleView=V)}typeof n.setModuleView=="function"&&this._lastAppliedModuleView!==this._currentModuleView&&(n.setModuleView(this._currentModuleView),this._lastAppliedModuleView=this._currentModuleView),typeof n.setShowVTToggle=="function"&&n.setShowVTToggle(e.show_vt_toggle!==!1),typeof n.setShowViewToggle=="function"&&n.setShowViewToggle(e.show_view_toggle===!0),typeof n.setHeaderDisplayOptions=="function"&&n.setHeaderDisplayOptions({showPower:e.show_power!==!1,showETA:e.show_eta!==!1,showProductCapacity:e.show_product_capacity!==!1}),n.setDisplayUnit?.(y),this._lastAppliedView!==this._currentView&&(this._currentView==="temperature"?n.showTemperature():n.showVoltage()),n.setBMUPower(o.power??0),n.setBMUVersion(o.version||""),n.setBMSVersion(u.bmsVersion||""),n.setUIMeta?.(`UI ${ee}<br>modules:${u.modules}`),n.setStateOfCharge(u.soc??o.soc??0),n.setStateOfHealth(u.soh??0);let N=this._hass.states||{},S=N[`sensor.bms_${u.id}_charge_total_energy`],T=N[`sensor.bms_${u.id}_discharge_total_energy`],D=N[`sensor.bms_${u.id}_efficiency`],R=V=>{if(!V)return{txt:"--",unit:""};let k=Number(V.state),F=(V.attributes?.unit_of_measurement||"").toString();return Number.isFinite(k)?/kwh/i.test(F)?{txt:Math.round(k).toLocaleString(void 0,{maximumFractionDigits:0}),unit:"kWh"}:/wh/i.test(F)?{txt:Math.round(k).toLocaleString(void 0,{maximumFractionDigits:0}),unit:"Wh"}:{txt:Math.round(k).toString(),unit:F}:{txt:"--",unit:""}},A=R(S),B=R(T),te=S||T?`Charged: ${A.txt} ${A.unit}<br>Discharged: ${B.txt} ${B.unit}`:"",j=Number(D?.state),ie=`Efficiency: ${Number.isFinite(j)?Math.round(j):"--"}%<br>State of Health: ${Number.isFinite(Number(u.soh))?Math.round(Number(u.soh)):0}%`,se=`BMU ${o.version||""}<br>BMS ${u.bmsVersion||""}`,ae=`UI ${ee}<br>modules:${u.modules}`;typeof n.setHeaderInformation=="function"&&n.setHeaderInformation({default:e.header_information_default||"versions",show:{versions:e.show_header_versions!==!1,ui:e.show_header_ui!==!1,energy:e.show_header_energy!==!1,efficiency:e.show_header_efficiency!==!1},payload:{versionsText:se,uiText:ae,energyText:te,effText:ie}}),typeof n.setTowerCapacityWh=="function"&&n.setTowerCapacityWh(w);let $="",P=Number(u.soc??o.soc??0),ne=20,X=Number(o.power??0),J=X/(s||1);if(w>0&&P>=0&&Math.abs(J)>ne){let V=l;(V===0||V>0!=J>0)&&(V=X);let k=V/(s||1);if(k<0){let U=w*Math.max(0,1-P/100)/Math.abs(k)*3600,L=C(U);$=L?`Full in ${L}`:""}else if(k>0){let U=w*Math.max(0,P/100)/k*3600,L=C(U);$=L?`Remaining ${L}`:""}}typeof n.setEstimate=="function"&&n.setEstimate($),n.setVoltage(u.voltage),n.setHistoryMaxVoltage(u.histMax),n.setHistoryMinVoltage(u.histMin),n.setCellBallancing(u.balancing),n.setTemperature(u.temps)}this._lastAppliedView=this._currentView,this._applyProductNames(i,s).catch(()=>{})}_discoverBMU(){let e=this._hass.states,t=Object.keys(e),i=d=>{let c=t.find(_=>d.test(_));return c?e[c]:void 0},s=Number(i(/^sensor\.bmu_power/)?.state)||0,o=i(/^sensor\.bmu_version$/)?.state||i(/^sensor\.bmu_version_a$/)?.state||"",l=i(/^sensor\.total_capacity$/),a;if(l){let d=Number(l.state),c=l.attributes?.unit_of_measurement||"";Number.isFinite(d)&&(a=/kwh/i.test(c)?d*1e3:d)}let r=i(/^sensor\.bmu_cell_voltage_max/),h;if(r){let d=Number(r.state),c=(r.attributes?.unit_of_measurement||"").toString();Number.isFinite(d)&&(h=/mv/i.test(c)?d/1e3:d)}return{power:s,version:o,totalCapacityWh:a,cellMaxV:h}}_discoverTowers(){let e=[],t=this._hass.states,i=Object.keys(t),s=[...new Set(i.map(a=>{let r=/^sensor\.bms_(\d+)_cells_average_voltage$/.exec(a);return r?Number(r[1]):null}).filter(Boolean))].sort((a,r)=>a-r).slice(0,3),o=a=>!Array.isArray(a)||a.length===0?0:a.length&&typeof a[0]=="object"&&!Array.isArray(a[0])?a.reduce((r,h)=>{let d=Number(h?.m??h?.module);return Number.isFinite(d)?Math.max(r,d):r},0):a.length,l=(a,r,h)=>{let d=Array.from({length:h},()=>[]);if(!Array.isArray(a))return d;if(a.length&&typeof a[0]=="object"&&!Array.isArray(a[0]))for(let c of a){let _=(Number(c?.m??c?.module)||1)-1;if(_>=0&&_<h){let p=c?.[r];d[_]=Array.isArray(p)?p:[]}}else for(let c=0;c<Math.min(h,a.length);c++)d[c]=Array.isArray(a[c])?a[c]:[];return d};for(let a of s){let r=t[`sensor.bms_${a}_cells_average_voltage`],h=t[`sensor.bms_${a}_max_history_cell_voltage`],d=t[`sensor.bms_${a}_min_history_cell_voltage`],c=t[`sensor.bms_${a}_cells_balancing`],_=t[`sensor.bms_${a}_cells_average_temperature`],p=t[`sensor.bms_${a}_state_of_charge`],g=t[`sensor.bms_${a}_state_of_health`],x=t["sensor.bms_version"],b=r?.attributes?.cell_voltages||[],M=h?.attributes?.cell_voltages||[],E=d?.attributes?.cell_voltages||[],w=c?.attributes?.cell_balancing||[],C=_?.attributes?.cell_temps||[],f=Math.max(o(b),o(M),o(E),o(w),o(C)),y=Math.min(Math.max(f||1,1),10),m=l(b,"v",y),u=l(M,"v",y),n=l(E,"v",y),v=l(w,"b",y),N=l(C,"t",y),S=n.flat().filter(R=>Number.isFinite(R)),T=u.flat().filter(R=>Number.isFinite(R)),D={vMin:S.length?Math.min(...S):3100,vMax:T.length?Math.max(...T):3700};e.push({id:a,modules:y,voltage:m,histMax:u,histMin:n,balancing:v,temps:N,chart:D,soc:Number(p?.state),soh:Number(g?.state),bmsVersion:x?.state||""})}return e.length===0?[this._demoTower(1)]:e}_demoTower(e){let s=Array.from({length:3},()=>Array.from({length:32},()=>3300+Math.round(Math.random()*80))),o=s.map(h=>h.map(d=>d+50)),l=s.map(h=>h.map(d=>d-80)),a=Array.from({length:3},()=>Array.from({length:16},()=>20+Math.round(Math.random()*15))),r=s.map(h=>h.map(()=>Math.random()<.05?1:0));return{id:e,modules:3,voltage:s,histMax:o,histMin:l,balancing:r,temps:a,chart:{vMin:3200,vMax:3500},soc:75,soh:98,bmsVersion:"demo"}}};I.prototype._ensureRegistries=async function(){if(!(this._entities&&this._devices)&&this._hass&&typeof this._hass.callWS=="function")try{let H=await this._hass.callWS({type:"config/entity_registry/list"}),e=await this._hass.callWS({type:"config/device_registry/list"});Array.isArray(H)?this._entities=H:this._entities=[],Array.isArray(e)?this._devices=e:this._devices=[]}catch{this._entities=this._entities||[],this._devices=this._devices||[]}};I.prototype._getModelForEntityId=function(H){if(!H||!Array.isArray(this._entities)||!Array.isArray(this._devices))return"";let e=this._entities.find(s=>s?.entity_id===H);if(!e)return"";let t=this._devices.find(s=>s?.id===e.device_id);return t?.model||t?.model_id||""||""};I.prototype._applyProductNames=async function(H,e){try{await this._ensureRegistries();let i=Object.keys(this._hass.states||{}).find(o=>/^sensor\.bmu_power/.test(o)),s=this._getModelForEntityId(i);for(let o=0;o<e;o++){let l=H[o];if(!l)continue;let a=this._el?.system?.getTower(o+1);if(!a)continue;let r=`sensor.bms_${l.id}_cells_average_voltage`,h=this._getModelForEntityId(r)||s||"";typeof a.setProductName=="function"&&a.setProductName(h)}}catch{}};customElements.get("byd-battery-box-visualization")||customElements.define("byd-battery-box-visualization",I);window.customCards=window.customCards||[];window.customCards.push({type:"byd-battery-box-visualization",name:"BYD Battery Box Visualization",description:"BYD Battery Box visualization with separated components and auto-configuration for byd_battery_box.",preview:!0,preview_image:"https://raw.githubusercontent.com/TimWeyand/byd_battery_box_visualization/main/images/preview.png"});var K=class extends HTMLElement{setConfig(e){if(this._config=e||{},this._form&&customElements.get("ha-form")){let t=this._config||{},i=t.voltage_auto===!1?"manualV":"autoV";if(this._lastSchemaKey!==i){this._lastSchemaKey=i,this._form.remove(),this._form=null,this._render();return}this._isEditing||(this._form.data={unit:t.unit||"mV",voltage_auto:t.voltage_auto!==!1,voltage_min:t.voltage_min,voltage_max:t.voltage_max,temp_min:t.temp_min,temp_max:t.temp_max,show_y_axis:t.show_y_axis!==!1,show_gray_caps:t.show_gray_caps!==!1,show_vt_toggle:t.show_vt_toggle!==!1,show_view_toggle:t.show_view_toggle===!0,show_power:t.show_power!==!1,show_eta:t.show_eta!==!1,show_product_capacity:t.show_product_capacity!==!1,header_information_default:t.header_information_default||"versions",show_header_versions:t.show_header_versions!==!1,show_header_ui:t.show_header_ui!==!1,show_header_energy:t.show_header_energy!==!1,show_header_efficiency:t.show_header_efficiency!==!1,module_view:t.module_view||"detailed"});return}this._render()}set hass(e){this._hass=e,this._form&&(this._form.hass=e)}connectedCallback(){this._render()}_render(){this.innerHTML="";let e=this,t=this._config||{};if(customElements.get("ha-form")){let n=document.createElement("ha-form");n.hass=this._hass;let v=t.voltage_auto!==!1,N=[{name:"voltage_auto",label:"Voltage auto",helper:"Default: active",selector:{boolean:{}}},...v?[]:[{name:"voltage_min",label:"Voltage min (mV)",helper:"Shown when Voltage auto is disabled",selector:{number:{mode:"box",min:0,step:1}}},{name:"voltage_max",label:"Voltage max (mV)",helper:"Shown when Voltage auto is disabled",selector:{number:{mode:"box",min:0,step:1}}}],{name:"temp_min",label:"Temperature min (\xB0C)",helper:"Default: 0",selector:{number:{mode:"box",min:-40,max:120,step:1}}},{name:"temp_max",label:"Temperature max (\xB0C)",helper:"Default: 60",selector:{number:{mode:"box",min:-40,max:120,step:1}}},{name:"show_gray_caps",label:"Show gray caps (voltage)",helper:"Default: active",selector:{boolean:{}}}],S=[{type:"expandable",title:"Battery Tower",schema:[{name:"unit",label:"Unit",helper:"Voltage unit for charts (not temperature). Default: mV",selector:{select:{options:[{value:"mV",label:"mV"},{value:"V",label:"V"}]}}},{name:"show_vt_toggle",label:"Show Voltage/Temperature Toggle",helper:"Default: active",selector:{boolean:{}}},{name:"show_view_toggle",label:"Show Battery Visualization Toggle (Detailed/Minimalistic)",helper:"Default: disabled",selector:{boolean:{}}},{name:"module_view",label:"Default Battery View",helper:"Default: Detailed",selector:{select:{options:[{value:"detailed",label:"Detailed"},{value:"minimal",label:"Minimalistic"},{value:"none",label:"No Data"}]}}},{name:"show_power",label:"Show Current Power",helper:"Default: active",selector:{boolean:{}}},{name:"show_eta",label:"Show Estimated Time (charge/discharge)",helper:"Default: active",selector:{boolean:{}}},{name:"show_product_capacity",label:"Show Product and Capacity",helper:"Default: active",selector:{boolean:{}}}]},{type:"expandable",title:"Header Information",schema:[{name:"header_information_default",label:"Default Information",helper:"Default: versions (BMU/BMS)",selector:{select:{options:[{value:"versions",label:"BMU/BMS Versions"},{value:"ui",label:"UI/Modules"},{value:"energy",label:"Total Energy"},{value:"efficiency",label:"Efficiency & SoH"}]}}},{name:"show_header_versions",label:"Show BMU/BMS Versions",helper:"Default: active",selector:{boolean:{}}},{name:"show_header_ui",label:"Show UI Information",helper:"Default: active",selector:{boolean:{}}},{name:"show_header_energy",label:"Show Total Energy",helper:"Default: active",selector:{boolean:{}}},{name:"show_header_efficiency",label:"Show Efficiency & State of Health",helper:"Default: active",selector:{boolean:{}}}]},{type:"expandable",title:"Graph Settings",schema:N},{type:"expandable",title:"Battery Module \u2013 Detailed Graph Settings",schema:[{name:"show_y_axis",label:"Show Y\u2011axis",helper:"Default: active",selector:{boolean:{}}}]}];n.schema=S,this._lastSchemaKey=v?"autoV":"manualV",n.computeLabel=T=>T.label||T.name,n.computeHelper=T=>T.helper||"",n.data={unit:t.unit||"mV",voltage_auto:t.voltage_auto!==!1,show_vt_toggle:t.show_vt_toggle!==!1,show_view_toggle:t.show_view_toggle===!0,show_power:t.show_power!==!1,show_eta:t.show_eta!==!1,show_product_capacity:t.show_product_capacity!==!1,header_information_default:t.header_information_default||"versions",show_header_versions:t.show_header_versions!==!1,show_header_ui:t.show_header_ui!==!1,show_header_energy:t.show_header_energy!==!1,show_header_efficiency:t.show_header_efficiency!==!1,module_view:t.module_view||"detailed",voltage_min:t.voltage_min,voltage_max:t.voltage_max,temp_min:t.temp_min,temp_max:t.temp_max,show_y_axis:t.show_y_axis!==!1,show_gray_caps:t.show_gray_caps!==!1},n.addEventListener("value-changed",T=>{T.stopPropagation(),this._isEditing=!0;let D=T.detail?.value||{},R={};Object.keys(D).forEach(A=>{D[A]!==void 0&&(R[A]=D[A])}),clearTimeout(this._debounceT),this._debounceT=setTimeout(()=>{let B={...this._config||t||{},...R};B.voltage_auto!==!1&&(delete B.voltage_min,delete B.voltage_max),this.dispatchEvent(new CustomEvent("config-changed",{detail:{config:B}}))},300)}),n.addEventListener("focusin",()=>{this._isEditing=!0}),this._form=n,e.appendChild(n);return}let i=document.createElement("div");i.style.display="grid",i.style.gridTemplateColumns="1fr 1fr",i.style.gap="8px";let s=(n,v,N)=>{let S=document.createElement("label");S.textContent=n,S.style.fontSize="12px",S.style.opacity="0.85";let T=document.createElement("div");T.textContent=N||"",T.style.fontSize="11px",T.style.opacity="0.7",T.style.marginBottom="2px";let D=document.createElement("div");D.style.display="flex",D.style.flexDirection="column",D.appendChild(S),N&&D.appendChild(T),D.appendChild(v),i.appendChild(D)},o=n=>{let v=document.createElement("input");return v.type="text",v.value=n||"",v},l=n=>{let v=document.createElement("input");return v.type="number",n!==void 0&&(v.value=n),v},a=n=>{let v=document.createElement("input");return v.type="checkbox",v.checked=!!n,v},r=(n,v)=>{let N=document.createElement("select");return v.forEach(S=>{let T=document.createElement("option");T.value=S.value||S,T.textContent=S.label||S,(S.value||S)===n&&(T.selected=!0),N.appendChild(T)}),N},h=o(t.entity||"");s("Entity (optional)",h,"Usually auto-discovered.");let d=r(t.unit||"mV",["mV","V"]);s("Unit",d,"Default: mV");let c=r(t.module_view||"detailed",[{value:"detailed",label:"Detailed Graph"},{value:"minimalistic",label:"Minimalistic View"},{value:"no-data",label:"No Data"}]);s("Battery Module View",c,"Default: Detailed Graph");let _=a(t.show_vt_toggle!==!1);s("Show Voltage/Temperature Toggle",_,"Default: active");let p=a(t.show_view_toggle===!0);s("Show Battery Visualization Toggle",p,"Default: disabled");let g=a(t.show_power!==!1);s("Show Current Power",g,"Default: active");let x=a(t.show_eta!==!1);s("Show Estimated Time",x,"Default: active");let b=a(t.show_product_capacity!==!1);s("Show Product and Capacity",b,"Default: active");let M=a(t.voltage_auto!==!1);s("Voltage auto",M,"Default: active");let E,w;M.checked||(E=l(t.voltage_min),s("Voltage min (mV)",E,"Shown when Voltage auto is disabled"),w=l(t.voltage_max),s("Voltage max (mV)",w,"Shown when Voltage auto is disabled"));let C=l(t.temp_min);s("Temperature min (\xB0C)",C,"Default: 0");let f=l(t.temp_max);s("Temperature max (\xB0C)",f,"Default: 60");let y=a(t.show_gray_caps!==!1);s("Show gray caps (voltage)",y,"Default: active");let m=a(t.show_y_axis!==!1);s("Show Y\u2011axis",m,"Default: active");let u=()=>{let n={entity:h.value,unit:d.value,module_view:c.value,show_vt_toggle:_.checked,show_view_toggle:p.checked,show_power:g.checked,show_eta:x.checked,show_product_capacity:b.checked,voltage_auto:M.checked,voltage_min:!M.checked&&E&&E.value!==""?Number(E.value):void 0,voltage_max:!M.checked&&w&&w.value!==""?Number(w.value):void 0,temp_min:C.value===""?void 0:Number(C.value),temp_max:f.value===""?void 0:Number(f.value),show_y_axis:m.checked,show_gray_caps:y.checked};n.voltage_auto&&(delete n.voltage_min,delete n.voltage_max),this.dispatchEvent(new CustomEvent("config-changed",{detail:{config:{...t,...n}}}))};i.addEventListener("change",u),e.appendChild(i)}};customElements.get("byd-battery-box-visualization-editor")||customElements.define("byd-battery-box-visualization-editor",K);typeof globalThis<"u"?globalThis.__BYD_CSS_TEXT=z:typeof window<"u"&&(window.__BYD_CSS_TEXT=z);
